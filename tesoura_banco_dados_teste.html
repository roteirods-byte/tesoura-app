<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TESOURA - BANCO DE DADOS (GUARDIÃO)</title>
  <style>
    :root{
      --bg:#061424;
      --panel:#071c33;
      --line:#0f2c4a;
      --txt:#e9f2ff;
      --pumpkin:#ff7a1a;
      --ok:#27d07d;
      --warn:#ffb020;
      --btn:#8ad0ff;
      --btnTxt:#052033;
    }
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px;}
    h1{margin:0 0 14px 0;font-size:18px;color:var(--pumpkin);letter-spacing:.5px;}
    .card{background:linear-gradient(180deg,var(--panel),#061528);border:1px solid var(--line);border-radius:14px;padding:14px 14px 12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:#cfe4ff}
    select,input{height:34px;border-radius:9px;border:1px solid #204a73;background:#041021;color:var(--txt);padding:0 10px;min-width:220px;outline:none}
    .btn{height:34px;border-radius:9px;border:0;padding:0 14px;font-weight:700;cursor:pointer}
    .btn-ok{background:var(--ok);color:#052033}
    .btn-warn{background:var(--warn);color:#052033}
    .btn-blue{background:var(--btn);color:var(--btnTxt)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .status{margin-top:10px;font-size:12px;color:#cfe4ff}
    .status b{color:var(--pumpkin)}
    .box{margin-top:12px;border:1px dashed #2a5b86;border-radius:12px;padding:12px;min-height:70px;background:rgba(0,0,0,.15)}
    .k{color:var(--pumpkin);font-weight:700}
    .muted{opacity:.85}
    .small{font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .err{color:#ff6b6b}
    .ok{color:#76ffb0}
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CSV/Excel/PDF libs (only used on download) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>TESOURA - BANCO DE DADOS (GUARDIÃO)</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>PAINEL / ARQUIVO</label><br/>
          <select id="selPainel">
            <option value="">Carregando...</option>
          </select>
        </div>

        <div>
          <label>PERÍODO</label><br/>
          <select id="selPeriodo" disabled>
            <option value="">Selecione o painel</option>
          </select>
        </div>

        <div>
          <label class="muted">AÇÕES</label><br/>
          <button class="btn btn-ok" id="btnCarregar">CARREGAR</button>
          <button class="btn btn-warn" id="btnLimpar">LIMPAR</button>
        </div>
      </div>

      <div class="status" id="status">
        <span class="muted">Status:</span> <b>iniciando…</b>
      </div>

      <div class="box" id="boxResultado">
        <div class="muted">Selecione <b>PAINEL</b> e <b>PERÍODO</b> e clique <b>CARREGAR</b>.</div>
        <div class="small muted" style="margin-top:8px">Aqui você vê apenas o <span class="k">histórico de arquivos salvos</span> e pode baixar. Visualização/edição é feita no próprio painel.</div>
        <div id="listaArquivos" style="margin-top:10px"></div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn btn-blue" id="btnPdf" disabled>BAIXAR PDF</button>
        <button class="btn btn-blue" id="btnCsv" disabled>BAIXAR CSV</button>
        <button class="btn btn-blue" id="btnXlsx" disabled>BAIXAR EXCEL</button>
      </div>

      <div class="small muted" style="margin-top:10px">
        Banco de Dados é <span class="k">somente leitura</span>: não edita, não salva e não exclui.
      </div>
    </div>
  </div>

<script>
(() => {
  // === CONFIG (usar as mesmas do seu projeto) ===
  // Se já existir no window (definido em outro painel), reaproveita.
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_ANON = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
  // Observação: se seu site já define TESOURA_SUPABASE_URL e TESOURA_SUPABASE_ANON_KEY em outro arquivo,
  // não precisa mexer aqui. Se não define, cole a ANON KEY correta acima.

  const elPainel = document.getElementById("selPainel");
  const elPeriodo = document.getElementById("selPeriodo");
  const elStatus = document.getElementById("status");
  const elBox = document.getElementById("boxResultado");

  const btnCarregar = document.getElementById("btnCarregar");
  const btnLimpar = document.getElementById("btnLimpar");
  const btnPdf = document.getElementById("btnPdf");
  const btnCsv = document.getElementById("btnCsv");
  const btnXlsx = document.getElementById("btnXlsx");

  // Evita conflito: NÃO use "supabase" como nome global
  const tesouraSupabase = (window.tesouraSupabaseClient)
    ? window.tesouraSupabaseClient
    : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Opcional: salva para reaproveitar em outros painéis sem redeclarar
  window.tesouraSupabaseClient = tesouraSupabase;

  let loadedRow = null;     // linha carregada de arquivos_app
  let loadedData = null;    // conteudo (json)
  const elLista = document.getElementById("listaArquivos");

  function setStatus(msg, kind="") {
    const cls = kind === "err" ? "err" : (kind === "ok" ? "ok" : "");
    elStatus.innerHTML = `<span class="muted">Status:</span> <b class="${cls}">${escapeHtml(msg)}</b>`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[s]));
  }

  function enableDownloads(on) {
    btnPdf.disabled = !on;
    btnCsv.disabled = !on;
    btnXlsx.disabled = !on;
  }

  function resetLoaded() {
    loadedRow = null;
    loadedData = null;
    enableDownloads(false);
    if (elLista) elLista.innerHTML = "";
  }

  async function loadPainelOptions() {
    setStatus("carregando lista de painéis…");
    elPainel.innerHTML = `<option value="">Carregando...</option>`;
    elPeriodo.innerHTML = `<option value="">Selecione o painel</option>`;
    elPeriodo.disabled = true;

    // Busca painéis existentes
    const { data, error } = await tesouraSupabase
      .from("arquivos_app")
      .select("painel")
      .order("painel", { ascending: true });

    if (error) {
      setStatus("Erro ao listar painéis (ver Console).", "err");
      console.error("[BD] listar painéis:", error);
      elPainel.innerHTML = `<option value="">(erro)</option>`;
      return;
    }

    // ✅ SEMPRE MOSTRAR PAINÉIS OFICIAIS (mesmo sem arquivo salvo)
    const FIXOS = ["jogadores","presenca","escalacao","controle_geral","mensalidade","caixa","gols"];
    const doBanco = [...new Set((data || []).map(x => x.painel).filter(Boolean))];
    const unique = [...new Set([...FIXOS, ...doBanco])];

    if (!unique.length) {
      setStatus("Nenhum painel disponível.", "err");
      elPainel.innerHTML = `<option value="">(vazio)</option>`;
      return;
    }

    elPainel.innerHTML = `<option value="">Selecione…</option>` + unique.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    setStatus("pronto. selecione um painel.");
  }

  async function loadPeriodoOptions(painel) {
    resetLoaded();
    elPeriodo.disabled = false;
    const PERIODOS = {
      jogadores: ["unico"],
      presenca: ["semanal"],
      escalacao: ["semanal"],
      controle_geral: ["mensal","anual"],
      mensalidade: ["mensal","anual"],
      caixa: ["mensal","anual"],
      gols: ["anual"],
    };
    const opts = PERIODOS[painel] || ["unico","semanal","mensal","anual"];
    elPeriodo.innerHTML = `<option value="">Selecione…</option>` + opts.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    setStatus("pronto. selecione o período e clique CARREGAR.");
  }

  function buildFileNameBase() {
    const p = elPainel.value || "arquivo";
    const per = elPeriodo.value || "periodo";
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    return `tesoura_${p}_${per}_${stamp}`.toLowerCase();
  }

  function normalizeToRows(obj) {
    // Converte vários formatos para "linhas" (array de objetos)
    if (!obj) return [];
    if (Array.isArray(obj)) return obj;
    if (typeof obj === "object") {
      // caso venha { rows: [...] } ou { data: [...] }
      if (Array.isArray(obj.rows)) return obj.rows;
      if (Array.isArray(obj.data)) return obj.data;
      // caso seja um único registro
      return [obj];
    }
    return [];
  }

  function renderListaArquivos(rows) {
    if (!elLista) return;
    if (!rows || !rows.length) {
      elLista.innerHTML = `<div class="muted small">Nenhum arquivo salvo para esse painel/período.</div>`;
      return;
    }

    const head = `
      <div class="small muted" style="margin:6px 0 8px 0">Clique em um arquivo para habilitar o download:</div>
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #123a62;color:var(--pumpkin)">criado em</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #123a62;color:var(--pumpkin)">título</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #123a62;color:var(--pumpkin)">data ref</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #123a62;color:var(--pumpkin)">mês</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #123a62;color:var(--pumpkin)">ano</th>
            </tr>
          </thead>
          <tbody>
    `;

    const body = rows.map((r, idx) => {
      const criado = r.criado_em || r.created_at || "";
      return `
        <tr data-idx="${idx}" style="cursor:pointer">
          <td style="padding:6px;border-bottom:1px solid rgba(18,58,98,.55)">${escapeHtml(criado)}</td>
          <td style="padding:6px;border-bottom:1px solid rgba(18,58,98,.55)">${escapeHtml(r.titulo || "-")}</td>
          <td style="padding:6px;border-bottom:1px solid rgba(18,58,98,.55)">${escapeHtml(r.data_ref || "-")}</td>
          <td style="padding:6px;border-bottom:1px solid rgba(18,58,98,.55)">${escapeHtml(r.mes_ref ?? "-")}</td>
          <td style="padding:6px;border-bottom:1px solid rgba(18,58,98,.55)">${escapeHtml(r.ano_ref ?? "-")}</td>
        </tr>`;
    }).join("");

    const foot = `</tbody></table></div>`;
    elLista.innerHTML = head + body + foot;

    // click select
    [...elLista.querySelectorAll("tr[data-idx]")].forEach(tr => {
      tr.addEventListener("click", () => {
        const i = Number(tr.getAttribute("data-idx"));
        const row = rows[i];
        loadedRow = row;
        loadedData = row.conteudo;
        enableDownloads(true);
        // highlight selection
        [...elLista.querySelectorAll("tr[data-idx]")].forEach(x => x.style.background = "");
        tr.style.background = "rgba(138,208,255,.10)";
        setStatus("arquivo selecionado. use BAIXAR.", "ok");
      });
    });
  }

  async function carregarArquivo() {
    resetLoaded();
    const painel = elPainel.value;
    const periodo = elPeriodo.value;

    if (!painel) { setStatus("Selecione o painel.", "err"); return; }
    if (!periodo) { setStatus("Selecione o período.", "err"); return; }

    setStatus("carregando histórico…");

    // Lista últimos 20 arquivos do painel/período (mais recente primeiro)
    const { data, error } = await tesouraSupabase
      .from("arquivos_app")
      .select("id,painel,periodo,data_ref,mes_ref,ano_ref,titulo,conteudo,criado_em,created_at")
      .eq("painel", painel)
      .eq("periodo", periodo)
      .order("created_at", { ascending: false })
      .order("criado_em", { ascending: false })
      .limit(20);

    if (error) {
      setStatus("Erro ao carregar arquivo do Banco de Dados.", "err");
      console.error("[BD] carregar:", error);
      return;
    }

    renderListaArquivos(data || []);
    if (!data || !data.length) {
      setStatus("nenhum arquivo salvo para esse painel/período.", "err");
      return;
    }
    setStatus("histórico carregado. selecione um arquivo.", "ok");
  }

  // ==== DOWNLOADS ====
  function downloadBlob(filename, mime, content) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  function baixarCSV() {
    if (!loadedData) return;
    const rows = normalizeToRows(loadedData);
    if (!rows.length) { setStatus("Conteúdo vazio para CSV.", "err"); return; }

    const cols = Object.keys(rows[0]);
    const esc = (v) => {
      const s = (v === null || v === undefined) ? "" : String(v);
      const needs = /[",\n;]/.test(s);
      const ss = s.replace(/"/g,'""');
      return needs ? `"${ss}"` : ss;
    };

    const lines = [];
    lines.push(cols.map(esc).join(";"));
    rows.forEach(r => lines.push(cols.map(c => esc(r[c])).join(";")));

    downloadBlob(buildFileNameBase() + ".csv", "text/csv;charset=utf-8", lines.join("\n"));
    setStatus("CSV gerado.", "ok");
  }

  function baixarXLSX() {
    if (!loadedData) return;
    const rows = normalizeToRows(loadedData);
    if (!rows.length) { setStatus("Conteúdo vazio para Excel.", "err"); return; }

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DADOS");
    const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });

    downloadBlob(buildFileNameBase() + ".xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", out);
    setStatus("Excel gerado.", "ok");
  }

  async function baixarPDF() {
    if (!loadedData) return;
    const rows = normalizeToRows(loadedData);
    if (!rows.length) { setStatus("Conteúdo vazio para PDF.", "err"); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    const title = `TESOURA - ${loadedRow?.painel || ""} (${loadedRow?.periodo || ""})`;
    doc.setFontSize(12);
    doc.text(title, 40, 40);

    const cols = Object.keys(rows[0]);
    doc.setFontSize(9);

    let y = 60;
    const lineH = 14;
    const maxLines = 35; // simples, sem tabela complexa (leve e estável)
    const maxRows = Math.min(rows.length, maxLines);

    doc.text(cols.join(" | "), 40, y); y += lineH;
    doc.text("-".repeat(120).slice(0, 120), 40, y); y += lineH;

    for (let i=0;i<maxRows;i++){
      const r = rows[i];
      const line = cols.map(c => String(r[c] ?? "")).join(" | ");
      const chunks = doc.splitTextToSize(line, 520);
      chunks.forEach(ch => {
        if (y > 760) { doc.addPage(); y = 40; }
        doc.text(ch, 40, y); y += lineH;
      });
    }

    if (rows.length > maxRows) {
      doc.text(`(Mostrando ${maxRows} de ${rows.length} linhas)`, 40, Math.min(y+10, 780));
    }

    doc.save(buildFileNameBase() + ".pdf");
    setStatus("PDF gerado.", "ok");
  }

  // ==== EVENTS ====
  elPainel.addEventListener("change", async () => {
    const painel = elPainel.value;
    if (!painel) {
      elPeriodo.disabled = true;
      elPeriodo.innerHTML = `<option value="">Selecione o painel</option>`;
      resetLoaded();
      setStatus("selecione um painel.");
      return;
    }
    await loadPeriodoOptions(painel);
  });

  btnCarregar.addEventListener("click", carregarArquivo);
  btnLimpar.addEventListener("click", () => { resetLoaded(); setStatus("limpo."); });

  btnCsv.addEventListener("click", baixarCSV);
  btnXlsx.addEventListener("click", baixarXLSX);
  btnPdf.addEventListener("click", baixarPDF);

  // ==== START ====
  // Validação mínima da chave (evita “morto” sem aviso)
  if (!SUPABASE_ANON || SUPABASE_ANON.includes("COLE_AQUI")) {
    setStatus("Falta ANON KEY do Supabase (ver topo do arquivo).", "err");
    console.warn("[BD] ANON KEY não configurada.");
  } else {
    loadPainelOptions();
  }
})();
</script>
</body>
</html>
