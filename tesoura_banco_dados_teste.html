<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - BANCO DE DADOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:6px;padding:12px;box-shadow:0 2px 4px rgba(0,0,0,.4);margin-bottom:16px;font-size:13px}
    button{padding:6px 10px;border-radius:4px;border:none;cursor:pointer;font-weight:bold;text-transform:uppercase;font-size:11px}
    .btn-sec{background:#0ea5e9;color:#0f172a}
    .btn-ok{background:#22c55e;color:#022c22}
    .btn-del{background:#ef4444;color:#f9fafb}
    .btn-warn{background:#f97316;color:#0f172a}
    select,input{padding:6px;border-radius:4px;border:1px solid #334155;background:#0b1120;color:#f9fafb;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #4b5563;padding:3px 4px;text-align:center;text-transform:uppercase;white-space:nowrap}
    th{background:#f97316;color:#0f172a;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1;min-width:180px}
    .small{min-width:140px}
    .status{margin-top:6px;font-size:12px}
    .scroll{overflow:auto;max-height:520px}
    .erroBox{margin-top:8px;padding:10px;border:1px solid #ef4444;border-radius:6px;color:#fecaca;background:#1f0a0a;display:none}
    @media print{
      header,.printbar,.actions{display:none !important}
      .scroll{max-height:none;overflow:visible}
      th{position:static}
    }
  
  /* Banco de Dados é somente leitura */
  .painel h2{display:none;}
  #editJson, #btnSalvarEdicao, #btnCancelarEdicao, #statusEdit{display:none !important;}
</style>
</head>
<body>
  <header>TESOURA - BANCO DE DADOS</header>

  <div class="printbar" style="text-align:right; padding:4px 16px 0 16px;">
    <button class="btn-sec" onclick="window.print()">IMPRIMIR / BAIXAR PAINEL</button>
  </div>

  <div class="container">

    <div class="painel">
      <h2>Selecionar tabela</h2>
      <div class="row">
        <select id="tabela" class="small">
          <option value="jogadores">JOGADORES</option>
          <option value="controle_geral">CONTROLE GERAL</option>
            <option value="mensalidades">MENSALIDADES</option>
          <option value="caixa">CAIXA</option>
          <option value="presencas">PRESENÇAS</option>
          <option value="escalacao">ESCALAÇÃO</option>
          <option value="gols">GOLS</option>
        </select>

        <input id="filtroData" class="small" type="date" />
        <input id="filtroMes" class="small" type="text" placeholder="MÊS (ex: 12)" />
        <input id="filtroAno" class="small" type="text" placeholder="ANO (ex: 2025)" />

        <button id="btnCarregar" class="btn-ok">CARREGAR</button>
        <button id="btnLimpar" class="btn-warn">LIMPAR FILTROS</button>
      </div>

      <div id="status" class="status"></div>
      <div id="erroBox" class="erroBox"></div>
    </div>

    <div class="painel">
      <h2>Registros</h2>
      <div class="scroll">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="painel">
      <h2>Editar (linha selecionada)</h2>
      <div class="row">
        <input id="editJson" class="grow" placeholder='Cole aqui o JSON da linha' />
        <button id="btnSalvarEdicao" class="btn-ok actions">SALVAR EDIÇÃO</button>
        <button id="btnCancelarEdicao" class="btn-warn actions">CANCELAR</button>
      </div>
      <div class="status" id="statusEdit"></div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elTabela = document.getElementById("tabela");
    const elAno = document.getElementById("filtroAno");
    const elMes = document.getElementById("filtroMes");
    const elData = document.getElementById("filtroData");
    const btnCarregar = document.getElementById("btnCarregar");
    const btnLimpar = document.getElementById("btnLimpar");
    const status = document.getElementById("status");
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    // Ano padrão = ano vigente
    const anoVigente = new Date().getFullYear();
    if(elAno){ elAno.value = String(anoVigente); }

    function setStatus(msg){
      if(status) status.textContent = msg || "";
    }

    function limparTabela(){
      thead.innerHTML = "";
      tbody.innerHTML = "";
      setStatus("");
    }

    function mostrarFiltro(){
      const t = elTabela.value;

      // Padrão: esconder tudo
      elAno.style.display = "none";
      elMes.style.display = "none";
      elData.style.display = "none";

      // Jogadores / Gols: sem filtro
      if(t === "jogadores" || t === "gols"){
        return;
      }

      // Presenças / Escalação: filtro por DOMINGO (data)
      if(t === "presencas" || t === "escalacao"){
        elAno.style.display = "";
        elData.style.display = "";
        elAno.value = String(anoVigente);
        return;
      }

      // Mensalidades / Caixa / Controle Geral: filtro por MÊS
      if(t === "mensalidades" || t === "caixa" || t === "controle_geral"){
        elAno.style.display = "";
        elMes.style.display = "";
        elAno.value = String(anoVigente);
        if(!elMes.value) elMes.value = String(new Date().getMonth()+1);
        return;
      }
    }

    async function carregar(){
      try{
        btnCarregar.disabled = true;
        setStatus("Carregando...");

        const tabela = elTabela.value;

        // Mapeamento: select -> arquivos_app.painel
        const painelMap = {
          jogadores: "jogadores",
          gols: "gols",
          presencas: "presenca",
          escalacao: "escalacao",
          mensalidades: "mensalidade",
          caixa: "caixa",
          controle_geral: "controle_geral"
        };
        const painel = painelMap[tabela];

        if(!painel){
          setStatus("Selecione uma tabela.");
          return;
        }

        let query = supabase.from("arquivos_app").select("*").eq("painel", painel);

        // Filtros
        if(tabela === "presencas" || tabela === "escalacao"){
          const data = (elData.value || "").trim();
          if(!data){
            setStatus("Selecione o DOMINGO.");
            return;
          }
          query = query.eq("data_ref", data);
        }

        if(tabela === "mensalidades" || tabela === "caixa" || tabela === "controle_geral"){
          const ano = parseInt(elAno.value || String(anoVigente), 10);
          const mes = parseInt(elMes.value || "0", 10);
          if(!mes){
            setStatus("Selecione o MÊS.");
            return;
          }
          query = query.eq("ano_ref", ano).eq("mes_ref", mes);
        }

        // Jogadores/Gols: pegar o mais recente
        query = query.order("criado_em", { ascending: false }).limit(1);

        const { data, error } = await query;
        if(error) throw error;

        if(!data || data.length === 0){
          setStatus("Nenhum arquivo arquivado encontrado.");
          limparTabela();
          return;
        }

        const arquivo = data[0];
        const conteudo = arquivo.conteudo || {};

        // Renderização: se tiver rows, mostra em tabela
        const rows = conteudo.rows || conteudo.presenca || conteudo.linhas || null;

        // Caso Presença: mostrar presentes (array simples)
        if(painel === "presenca"){
          const pres = conteudo.presentes || [];
          renderTabela(pres.map(x => ({
            id: x.id,
            apelido: x.apelido,
            hora: x.hora,
            obs: x.obs,
            nao_vai_jogar: x.nao_vai_jogar
          })));
          setStatus(`Presença do dia ${arquivo.data_ref || ""} carregada.`);
          return;
        }

        // Caso Escalação: mostrar duas listas
        if(painel === "escalacao"){
          const e1 = conteudo.escala1 || [];
          const e2 = conteudo.escala2 || [];
          renderTabela([
            { bloco: "1º TEMPO", ...{} },
            ...e1.map((r,i)=>({ bloco:"1º TEMPO", pos:i+1, amarelo:r.amarelo||"", azul:r.azul||"", saiu:r.saiu||"" })),
            { bloco: "2º TEMPO", ...{} },
            ...e2.map((r,i)=>({ bloco:"2º TEMPO", pos:i+1, amarelo:r.amarelo||"", azul:r.azul||"", saiu:r.saiu||"" }))
          ]);
          setStatus(`Escalação do dia ${arquivo.data_ref || ""} carregada.`);
          return;
        }

        // Padrão: rows
        if(Array.isArray(rows)){
          renderTabela(rows);
          setStatus("Arquivo carregado.");
        }else{
          // fallback: mostrar JSON em 1 linha
          renderTabela([{ conteudo_json: JSON.stringify(conteudo) }]);
          setStatus("Arquivo carregado.");
        }

      }catch(e){
        console.error(e);
        setStatus("Erro ao carregar. Verifique se você está logado como DIRETOR.");
      }finally{
        btnCarregar.disabled = false;
      }
    }

    function renderTabela(rows){
      limparTabela();
      if(!rows || rows.length === 0){
        setStatus("Sem registros.");
        return;
      }

      const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      thead.innerHTML = "<tr>" + cols.map(c => `<th>${c}</th>`).join("") + "</tr>";
      tbody.innerHTML = rows.map(r => "<tr>" + cols.map(c => `<td>${(r[c] ?? "")}</td>`).join("") + "</tr>").join("");
    }

    elTabela.addEventListener("change", () => { mostrarFiltro(); limparTabela(); });
    btnCarregar.addEventListener("click", carregar);
    btnLimpar.addEventListener("click", () => { limparTabela(); });

    // Inicial
    mostrarFiltro();
    limparTabela();
  </script>
</body>
</html>
