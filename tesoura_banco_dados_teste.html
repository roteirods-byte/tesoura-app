<!-- SUBSTITUA TODO O CONTEÚDO DO ARQUIVO tesoura_banco_dados_teste.html POR ESTE -->
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TESOURA - BANCO DE DADOS (GUARDIÃO)</title>
  <style>
    :root{
      --bg:#071a2b; --panel:#0b2640; --panel2:#082033;
      --txt:#e8f0ff; --muted:#a9bfdc; --accent:#ff8a00;
      --btn:#1da2ff; --btn2:#00c26a; --danger:#ff3b3b;
      --line:rgba(255,255,255,.12);
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif;}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px;}
    h1{margin:0 0 10px;color:var(--accent);font-size:18px;letter-spacing:.5px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:14px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .field{min-width:220px;flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    select,input{width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#061626;color:var(--txt);outline:none}
    .btn{padding:9px 14px;border-radius:10px;border:0;color:#00121f;font-weight:700;cursor:pointer}
    .btnBuscar{background:var(--btn2)}
    .btnLimpar{background:#ffb000}
    .btnDl{background:var(--btn);color:#00121f}
    .btnDl[disabled]{opacity:.35;cursor:not-allowed}
    .status{margin:8px 0 0;color:var(--accent);font-size:12px}
    .box{margin-top:12px;border:1px dashed var(--line);border-radius:12px;padding:12px}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--accent);font-size:12px}
    tr:hover{background:rgba(255,255,255,.04)}
    .footer{margin-top:10px;font-size:12px;color:var(--muted)}
    .note{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TESOURA - BANCO DE DADOS (GUARDIÃO)</h1>

    <div class="card">
      <div class="row">
        <div class="field">
          <label>PAINEL / ARQUIVO</label>
          <select id="selPainel"></select>
        </div>

        <div class="field">
          <label>PERÍODO</label>
          <select id="selPeriodo"></select>
        </div>

        <div class="field" id="refArea"></div>

        <div class="field" style="min-width:260px;flex:0">
          <label>AÇÕES</label>
          <div class="row" style="gap:8px">
            <button class="btn btnBuscar" id="btnBuscar">BUSCAR</button>
            <button class="btn btnLimpar" id="btnLimpar">LIMPAR</button>
          </div>
        </div>
      </div>

      <div class="status" id="status">Selecione PAINEL e PERÍODO e clique BUSCAR.</div>

      <div class="box">
        <div class="small">
          Aqui você vê apenas o <b>histórico de arquivos salvos</b> e pode baixar.
          Visualização/edição é feita no próprio painel.
        </div>

        <table id="tbl" style="display:none">
          <thead>
            <tr>
              <th>criado em</th>
              <th>título</th>
              <th>referência</th>
              <th>tipo</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="row" style="justify-content:flex-end;margin-top:12px;gap:10px">
          <button class="btn btnDl" id="btnPdf" disabled>BAIXAR PDF</button>
          <button class="btn btnDl" id="btnCsv" disabled>BAIXAR CSV</button>
          <button class="btn btnDl" id="btnXls" disabled>BAIXAR EXCEL</button>
        </div>

        <div class="footer">Banco de Dados é <b>somente leitura</b>: não edita, não salva e não exclui.</div>
      </div>
    </div>
  </div>

<script>
/** CONFIG SUPABASE (usa a mesma do seu projeto) **/
const SUPABASE_URL = window.SUPABASE_URL || "https://xuplzpispuvktggjassx.supabase.co";
const SUPABASE_ANON = window.SUPABASE_ANON || window.SUPABASE_KEY || "";
const TABELA_ARQUIVOS = "arquivos_app";

// Painéis fixos (sempre aparecem)
const PAINEIS = [
  {id:"jogadores", label:"jogadores", periodos:["unico"]},
  {id:"presenca", label:"presença", periodos:["semanal"]},
  {id:"escalacao", label:"escalação", periodos:["semanal"]},
  {id:"controle_geral", label:"controle geral", periodos:["unico"]},
  {id:"mensalidade", label:"mensalidade", periodos:["mensal"]},
  {id:"caixa", label:"caixa", periodos:["semanal","mensal","anual"]},
  {id:"gols", label:"gols", periodos:["semanal","anual"]},
];

const selPainel = document.getElementById("selPainel");
const selPeriodo = document.getElementById("selPeriodo");
const refArea = document.getElementById("refArea");
const statusEl = document.getElementById("status");
const tbl = document.getElementById("tbl");
const tbody = document.getElementById("tbody");
const btnPdf = document.getElementById("btnPdf");
const btnCsv = document.getElementById("btnCsv");
const btnXls = document.getElementById("btnXls");

let selecionado = null; // linha de arquivos_app selecionada (para download)
let listaAtual = [];    // resultados

function setStatus(msg){ statusEl.textContent = msg; }

function pad2(n){ return String(n).padStart(2,"0"); }
function yyyy(d){ return d.getFullYear(); }

function buildPainel(){
  selPainel.innerHTML = PAINEIS.map(p=>`<option value="${p.id}">${p.label}</option>`).join("");
  onPainelChange();
}

function onPainelChange(){
  const painelId = selPainel.value;
  const p = PAINEIS.find(x=>x.id===painelId);
  selPeriodo.innerHTML = p.periodos.map(per=>`<option value="${per}">${per}</option>`).join("");
  onPeriodoChange();
}

function buildRefMensal(){
  const now = new Date();
  const ano = now.getFullYear();
  const meses = Array.from({length:12},(_,i)=>i+1);
  const anos = Array.from({length:8},(_,i)=>ano-3+i);

  refArea.innerHTML = `
    <label>REFERÊNCIA</label>
    <div class="row" style="gap:8px">
      <select id="refMes" style="min-width:120px;flex:0">
        ${meses.map(m=>`<option value="${m}">${pad2(m)}</option>`).join("")}
      </select>
      <select id="refAno" style="min-width:120px;flex:0">
        ${anos.map(a=>`<option value="${a}">${a}</option>`).join("")}
      </select>
    </div>
  `;
  document.getElementById("refMes").value = (now.getMonth()+1);
  document.getElementById("refAno").value = ano;
}

function buildRefAnual(){
  const now = new Date();
  const ano = now.getFullYear();
  const anos = Array.from({length:10},(_,i)=>ano-5+i);
  refArea.innerHTML = `
    <label>REFERÊNCIA</label>
    <select id="refAno">
      ${anos.map(a=>`<option value="${a}">${a}</option>`).join("")}
    </select>
  `;
  document.getElementById("refAno").value = ano;
}

function buildRefSemanalDomingo(){
  // calendário (sem digitação)
  refArea.innerHTML = `
    <label>REFERÊNCIA (DOMINGO)</label>
    <input id="refDomingo" type="date"/>
  `;
  // default: hoje
  const d = new Date();
  document.getElementById("refDomingo").value = d.toISOString().slice(0,10);
}

function buildRefCaixaIntervalo(){
  refArea.innerHTML = `
    <label>REFERÊNCIA (CAIXA SEMANAL)</label>
    <div class="row" style="gap:8px">
      <div style="flex:1;min-width:160px">
        <label class="small">DATA INÍCIO</label>
        <input id="refIni" type="date"/>
      </div>
      <div style="flex:1;min-width:160px">
        <label class="small">DATA FIM</label>
        <input id="refFim" type="date"/>
      </div>
    </div>
  `;
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  document.getElementById("refIni").value = iso;
  document.getElementById("refFim").value = iso;
}

function clearRef(){
  refArea.innerHTML = `<label>REFERÊNCIA</label><div class="small">Sem referência (arquivo único).</div>`;
}

function onPeriodoChange(){
  const painel = selPainel.value;
  const periodo = selPeriodo.value;

  // referência por regra
  if(periodo==="unico"){
    clearRef();
    return;
  }
  if(periodo==="mensal"){
    buildRefMensal();
    return;
  }
  if(periodo==="anual"){
    buildRefAnual();
    return;
  }
  // semanal
  if(painel==="caixa"){
    buildRefCaixaIntervalo(); // intervalo livre
  }else{
    buildRefSemanalDomingo(); // domingo
  }
}

async function supabaseSelect(url){
  const headers = {
    "apikey": SUPABASE_ANON,
    "Authorization": "Bearer " + SUPABASE_ANON,
    "Content-Type": "application/json",
    "Accept": "application/json",
  };
  const r = await fetch(url, {headers});
  if(!r.ok){
    const t = await r.text();
    throw new Error(t || ("HTTP "+r.status));
  }
  return r.json();
}

function buildQuery(){
  const painel = selPainel.value;
  const periodo = selPeriodo.value;

  // Campos esperados: painel, periodo, criado_em, titulo, data_ref, mes_ref, ano_ref, data_inicio, data_fim
  // Vamos filtrar apenas por campos disponíveis.
  let filter = `painel=eq.${encodeURIComponent(painel)}&periodo=eq.${encodeURIComponent(periodo)}`;

  if(periodo==="mensal"){
    const m = document.getElementById("refMes").value;
    const a = document.getElementById("refAno").value;
    filter += `&mes_ref=eq.${encodeURIComponent(m)}&ano_ref=eq.${encodeURIComponent(a)}`;
  }
  if(periodo==="anual"){
    const a = document.getElementById("refAno").value;
    filter += `&ano_ref=eq.${encodeURIComponent(a)}`;
  }
  if(periodo==="semanal"){
    if(painel==="caixa"){
      const ini = document.getElementById("refIni").value;
      const fim = document.getElementById("refFim").value;
      // caixa semanal usa data_inicio + data_fim (data_ref pode ser vazio)
      filter += `&data_inicio=eq.${encodeURIComponent(ini)}&data_fim=eq.${encodeURIComponent(fim)}`;
    }else{
      const d = document.getElementById("refDomingo").value;
      filter += `&data_ref=eq.${encodeURIComponent(d)}`;
    }
  }

  // Ordena pelos mais novos
  const select = `select=id,painel,periodo,criado_em,created_at,titulo,data_ref,mes_ref,ano_ref,data_inicio,data_fim`;
  const order = `order=criado_em.desc,created_at.desc`;
  return `${SUPABASE_URL}/rest/v1/${TABELA_ARQUIVOS}?${select}&${filter}&${order}`;
}

function renderTabela(rows){
  listaAtual = rows || [];
  selecionado = null;
  tbody.innerHTML = "";
  btnPdf.disabled = btnCsv.disabled = btnXls.disabled = true;

  if(!listaAtual.length){
    tbl.style.display = "none";
    setStatus("Nenhum arquivo salvo encontrado para este filtro.");
    return;
  }

  tbl.style.display = "";
  listaAtual.forEach((r,idx)=>{
    const criado = r.criado_em || r.created_at || "-";
    const titulo = r.titulo || "(sem título)";
    let ref = "-";
    if(r.periodo==="mensal") ref = `${pad2(r.mes_ref||"")}/${r.ano_ref||""}`;
    else if(r.periodo==="anual") ref = `${r.ano_ref||""}`;
    else if(r.periodo==="semanal"){
      if(r.painel==="caixa") ref = `${r.data_inicio||""} → ${r.data_fim||""}`;
      else ref = `${r.data_ref||""}`;
    }

    const tr = document.createElement("tr");
    tr.style.cursor="pointer";
    tr.innerHTML = `
      <td>${criado}</td>
      <td>${titulo}</td>
      <td>${ref}</td>
      <td>${r.periodo}</td>
    `;
    tr.addEventListener("click", ()=>{
      [...tbody.querySelectorAll("tr")].forEach(x=>x.style.outline="none");
      tr.style.outline = "2px solid rgba(255,138,0,.65)";
      selecionado = r;
      btnPdf.disabled = btnCsv.disabled = btnXls.disabled = false;
      setStatus("Arquivo selecionado. Escolha o tipo e baixe.");
    });
    tbody.appendChild(tr);
  });

  setStatus(`Histórico carregado: ${listaAtual.length} arquivo(s). Selecione um arquivo.`);
}

// Downloads: aqui só “simula” - você pode plugar seu gerador real depois.
// Por enquanto, baixa JSON do conteudo como arquivo.
function downloadAs(filename, mime, content){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 6000);
}

async function buscar(){
  try{
    setStatus("Buscando histórico...");
    btnPdf.disabled = btnCsv.disabled = btnXls.disabled = true;
    const url = buildQuery();
    const rows = await supabaseSelect(url);
    renderTabela(rows);
  }catch(e){
    console.error(e);
    setStatus("Erro ao buscar histórico no Supabase. Verifique chave/permite leitura da tabela arquivos_app.");
    tbl.style.display="none";
  }
}

function limpar(){
  tbody.innerHTML = "";
  tbl.style.display="none";
  btnPdf.disabled = btnCsv.disabled = btnXls.disabled = true;
  selecionado = null;
  setStatus("Selecione PAINEL e PERÍODO e clique BUSCAR.");
}

async function pegarConteudoSelecionado(){
  if(!selecionado) return null;
  // Busca o registro completo (incluindo conteudo) pelo id
  const url = `${SUPABASE_URL}/rest/v1/${TABELA_ARQUIVOS}?select=*&id=eq.${encodeURIComponent(selecionado.id)}&limit=1`;
  const rows = await supabaseSelect(url);
  return rows && rows[0] ? rows[0] : null;
}

async function baixar(tipo){
  try{
    if(!selecionado) return;
    setStatus("Preparando download...");
    const row = await pegarConteudoSelecionado();
    const conteudo = row && row.conteudo ? row.conteudo : {};
    const base = `${row.painel}_${row.periodo}_${(row.criado_em||row.created_at||"").replaceAll(":","-")}`;

    if(tipo==="csv"){
      // CSV simples: exporta JSON como texto (você pode trocar depois por CSV real)
      downloadAs(base+".csv", "text/csv;charset=utf-8", JSON.stringify(conteudo,null,2));
    }else if(tipo==="xls"){
      // Excel simples: exporta JSON (trocar depois pelo gerador real)
      downloadAs(base+".xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", JSON.stringify(conteudo,null,2));
    }else{
      // PDF simples: exporta JSON (trocar depois por PDF real)
      downloadAs(base+".pdf", "application/pdf", JSON.stringify(conteudo,null,2));
    }
    setStatus("Download iniciado.");
  }catch(e){
    console.error(e);
    setStatus("Erro ao baixar. Verifique se a coluna conteudo existe e se há permissão de leitura.");
  }
}

document.getElementById("btnBuscar").addEventListener("click", buscar);
document.getElementById("btnLimpar").addEventListener("click", limpar);
selPainel.addEventListener("change", onPainelChange);
selPeriodo.addEventListener("change", onPeriodoChange);
btnPdf.addEventListener("click", ()=>baixar("pdf"));
btnCsv.addEventListener("click", ()=>baixar("csv"));
btnXls.addEventListener("click", ()=>baixar("xls"));

buildPainel();
</script>
</body>
</html>
