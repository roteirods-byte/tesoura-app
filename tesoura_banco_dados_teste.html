<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - BANCO DE DADOS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:6px;padding:12px;box-shadow:0 2px 4px rgba(0,0,0,.4);margin-bottom:16px;font-size:13px}
    button{padding:6px 10px;border-radius:4px;border:none;cursor:pointer;font-weight:bold;text-transform:uppercase;font-size:11px}
    .btn-sec{background:#0ea5e9;color:#0f172a}
    .btn-ok{background:#22c55e;color:#022c22}
    .btn-del{background:#ef4444;color:#f9fafb}
    .btn-warn{background:#f97316;color:#0f172a}
    select,input,textarea{padding:6px;border-radius:4px;border:1px solid #334155;background:#0b1120;color:#f9fafb;font-size:12px}
    textarea{width:100%;min-height:140px;resize:vertical}
    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #4b5563;padding:3px 4px;text-align:center;text-transform:uppercase;white-space:nowrap}
    th{background:#f97316;color:#0f172a;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1;min-width:180px}
    .small{min-width:160px}
    .status{margin-top:6px;font-size:12px}
    .scroll{overflow:auto;max-height:520px}
    .erroBox{margin-top:8px;padding:10px;border:1px solid #ef4444;border-radius:6px;color:#fecaca;background:#1f0a0a;display:none}
    .hide{display:none}
    @media print{
      header,.no-print{display:none !important}
      .scroll{max-height:none;overflow:visible}
      th{position:static}
    }
  </style>
</head>
<body>
  <header>TESOURA - BANCO DE DADOS</header>

  <div class="container">

    <div class="painel no-print">
      <h2>Arquivos salvos</h2>

      <div class="row">
        <label class="small">
          Painel<br/>
          <select id="painel">
            <option value="jogadores">JOGADORES</option>
            <option value="presenca">PRESENÇA</option>
            <option value="escalacao">ESCALAÇÃO</option>
            <option value="controle">CONTROLE GERAL</option>
            <option value="mensalidade">MENSALIDADE</option>
            <option value="caixa">CAIXA</option>
            <option value="gols">GOLS</option>
          </select>
        </label>

        <label class="small">
          Período<br/>
          <select id="periodo">
            <option value="semanal">SEMANAL</option>
            <option value="mensal">MENSAL</option>
            <option value="anual">ANUAL</option>
          </select>
        </label>

        <label class="small" id="boxData">
          Data (domingo)<br/>
          <input id="dataRef" type="date"/>
        </label>

        <label class="small hide" id="boxMes">
          Mês (1-12)<br/>
          <input id="mesRef" type="number" min="1" max="12" placeholder="12"/>
        </label>

        <label class="small" id="boxAno">
          Ano<br/>
          <input id="anoRef" type="number" placeholder="2025"/>
        </label>

        <button id="btnCarregar" class="btn-ok">CARREGAR</button>
        <button id="btnLimpar" class="btn-warn">LIMPAR</button>
      </div>

      <div id="status" class="status"></div>
      <div id="erroBox" class="erroBox"></div>
    </div>

    <div class="painel">
      <h2>Lista</h2>
      <div class="scroll">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="painel hide" id="boxVisualizar">
      <h2>Visualizar arquivo</h2>
      <div class="row no-print">
        <button class="btn-sec" id="btnImprimir">IMPRIMIR</button>
        <button class="btn-sec" id="btnBaixar">BAIXAR (JSON)</button>
        <button class="btn-warn" id="btnFechar">FECHAR</button>
      </div>
      <div class="status" id="infoArquivo"></div>
      <textarea id="conteudo"></textarea>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xuplzpispukvtggjasxx.supabase.co";
    const SUPABASE_KEY = "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const elPainel = document.getElementById("painel");
    const elPeriodo = document.getElementById("periodo");
    const elData = document.getElementById("dataRef");
    const elMes = document.getElementById("mesRef");
    const elAno = document.getElementById("anoRef");

    const boxData = document.getElementById("boxData");
    const boxMes  = document.getElementById("boxMes");
    const boxAno  = document.getElementById("boxAno");

    const btnCarregar = document.getElementById("btnCarregar");
    const btnLimpar = document.getElementById("btnLimpar");

    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    const status = document.getElementById("status");
    const erroBox = document.getElementById("erroBox");

    const boxVisualizar = document.getElementById("boxVisualizar");
    const infoArquivo = document.getElementById("infoArquivo");
    const txtConteudo = document.getElementById("conteudo");
    const btnImprimir = document.getElementById("btnImprimir");
    const btnBaixar = document.getElementById("btnBaixar");
    const btnFechar = document.getElementById("btnFechar");

    let arquivoAtual = null;

    function setStatus(msg){ status.textContent = msg || ""; }
    function showErro(msg){
      erroBox.style.display="block";
      erroBox.textContent = msg || "ERRO";
    }
    function hideErro(){
      erroBox.style.display="none";
      erroBox.textContent="";
    }

    function aplicarPeriodoUI(){
      const p = elPeriodo.value;
      if (p === "semanal"){
        boxData.classList.remove("hide");
        boxMes.classList.add("hide");
        boxAno.classList.remove("hide");
      } else if (p === "mensal"){
        boxData.classList.add("hide");
        boxMes.classList.remove("hide");
        boxAno.classList.remove("hide");
      } else { // anual
        boxData.classList.add("hide");
        boxMes.classList.add("hide");
        boxAno.classList.remove("hide");
      }
    }

    function limpar(){
      elData.value="";
      elMes.value="";
      elAno.value="";
      thead.innerHTML="";
      tbody.innerHTML="";
      setStatus("");
      hideErro();
      fecharVisualizar();
    }

    function fecharVisualizar(){
      arquivoAtual = null;
      boxVisualizar.classList.add("hide");
      infoArquivo.textContent="";
      txtConteudo.value="";
    }

    function baixarJSON(nome, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = nome;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function carregar(){
      hideErro();
      fecharVisualizar();
      thead.innerHTML="";
      tbody.innerHTML="";
      setStatus("Carregando...");

      const painel = elPainel.value;
      const periodo = elPeriodo.value;

      let q = supabase.from("arquivos_app").select("*").eq("painel", painel).eq("periodo", periodo).order("criado_em", {ascending:false}).limit(200);

      const ano = (elAno.value || "").trim();
      const mes = (elMes.value || "").trim();
      const data = (elData.value || "").trim();

      if (periodo === "semanal"){
        if (data) q = q.eq("data_ref", data);
        if (ano) q = q.eq("ano_ref", parseInt(ano,10));
      }
      if (periodo === "mensal"){
        if (ano) q = q.eq("ano_ref", parseInt(ano,10));
        if (mes) q = q.eq("mes_ref", parseInt(mes,10));
      }
      if (periodo === "anual"){
        if (ano) q = q.eq("ano_ref", parseInt(ano,10));
      }

      const { data: rows, error } = await q;

      if (error){
        console.error(error);
        setStatus("ERRO AO CARREGAR.");
        showErro("Não consegui ler a tabela arquivos_app.\nPossíveis causas: tabela não criada, RLS bloqueando, ou permissão.\n\n" + (error.message || ""));
        return;
      }

      if (!rows || !rows.length){
        setStatus("Nenhum arquivo encontrado.");
        return;
      }

      const cols = ["id","painel","periodo","data_ref","mes_ref","ano_ref","titulo","criado_em"];
      const trH = document.createElement("tr");
      cols.forEach(c=>{
        const th=document.createElement("th");
        th.textContent=c;
        trH.appendChild(th);
      });
      ["VER","BAIXAR","IMPRIMIR","EXCLUIR"].forEach(t=>{
        const th=document.createElement("th");
        th.textContent=t;
        trH.appendChild(th);
      });
      thead.appendChild(trH);

      rows.forEach(r=>{
        const tr=document.createElement("tr");

        cols.forEach(c=>{
          const td=document.createElement("td");
          td.textContent = (r[c] ?? "");
          tr.appendChild(td);
        });

        const tdVer=document.createElement("td");
        const bVer=document.createElement("button");
        bVer.className="btn-sec no-print";
        bVer.textContent="VER";
        bVer.onclick=()=>abrirVisualizar(r);
        tdVer.appendChild(bVer);
        tr.appendChild(tdVer);

        const tdBaixar=document.createElement("td");
        const bB=document.createElement("button");
        bB.className="btn-sec no-print";
        bB.textContent="BAIXAR";
        bB.onclick=()=>{
          const nome = `tesoura_${r.painel}_${r.periodo}_${r.id}.json`;
          baixarJSON(nome, r.conteudo);
        };
        tdBaixar.appendChild(bB);
        tr.appendChild(tdBaixar);

        const tdImp=document.createElement("td");
        const bI=document.createElement("button");
        bI.className="btn-sec no-print";
        bI.textContent="IMPRIMIR";
        bI.onclick=()=>{
          abrirVisualizar(r);
          setTimeout(()=>window.print(), 50);
        };
        tdImp.appendChild(bI);
        tr.appendChild(tdImp);

        const tdDel=document.createElement("td");
        const bD=document.createElement("button");
        bD.className="btn-del no-print";
        bD.textContent="EXCLUIR";
        bD.onclick=()=>excluir(r.id);
        tdDel.appendChild(bD);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });

      setStatus("OK. Arquivos: " + rows.length);
    }

    function abrirVisualizar(r){
      arquivoAtual = r;
      boxVisualizar.classList.remove("hide");
      infoArquivo.textContent = `Arquivo #${r.id} | ${r.painel.toUpperCase()} | ${r.periodo.toUpperCase()} | ${r.criado_em}`;
      txtConteudo.value = JSON.stringify(r.conteudo, null, 2);
      window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
    }

    async function excluir(id){
      if (!confirm("Excluir o arquivo " + id + "?")) return;
      const { error } = await supabase.from("arquivos_app").delete().eq("id", id);
      if (error){
        console.error(error);
        showErro("Erro ao excluir: " + (error.message || ""));
        return;
      }
      await carregar();
    }

    // eventos
    elPeriodo.addEventListener("change", aplicarPeriodoUI);
    btnCarregar.addEventListener("click", carregar);
    btnLimpar.addEventListener("click", limpar);

    btnFechar.addEventListener("click", fecharVisualizar);
    btnImprimir.addEventListener("click", ()=>window.print());
    btnBaixar.addEventListener("click", ()=>{
      if (!arquivoAtual) return;
      baixarJSON(`tesoura_${arquivoAtual.painel}_${arquivoAtual.periodo}_${arquivoAtual.id}.json`, arquivoAtual.conteudo);
    });

    aplicarPeriodoUI();
  </script>
</body>
</html>
