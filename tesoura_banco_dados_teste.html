<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TESOURA — Banco de Dados</title>

  <style>
    :root{
      --bg:#071321;
      --panel:#0b233b;
      --panel2:#0c2a47;
      --line:#123a62;
      --text:#e8f0ff;
      --muted:#b8c8e6;
      --accent:#ff7a00;
      --ok:#2bd46a;
      --warn:#ffb020;
      --danger:#ff3b30;
      --btn:#8ad0ff;
      --btnTxt:#052033;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px 0;color:var(--accent);font-size:20px;letter-spacing:.2px}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .col{flex:1;min-width:220px}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px 2px}
    select{
      width:100%;
      height:38px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#071a2d;
      color:var(--text);
      padding:0 10px;
      outline:none;
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      height:38px;
      border:none;
      border-radius:10px;
      padding:0 14px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .btn-ok{background:var(--ok);color:#052033}
    .btn-warn{background:var(--warn);color:#052033}
    .btn-blue{background:var(--btn);color:var(--btnTxt)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .status{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }
    .status b{color:var(--text)}
    .status .ok{color:var(--ok);font-weight:700}
    .status .err{color:var(--danger);font-weight:700}
    .status .warn{color:var(--warn);font-weight:700}

    .result{
      margin-top:12px;
      border:1px dashed var(--line);
      border-radius:12px;
      padding:12px;
      min-height:140px;
      background:#071a2d;
    }
    .meta{
      display:flex;gap:14px;flex-wrap:wrap;
      margin-bottom:10px;
      color:var(--muted);
      font-size:13px;
    }
    .meta .k{color:var(--accent);font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .tableWrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--line);
      background:#061524;
    }
    table{border-collapse:collapse;width:100%;min-width:860px}
    th,td{
      border-bottom:1px solid #0e2f52;
      padding:7px 10px;
      text-align:left;
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    th{
      color:var(--accent);
      font-weight:800;
      background:#071a2d;
      position:sticky;
      top:0;
      z-index:2;
    }
    .downloads{
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      margin-top:12px;
    }
    .foot{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .foot b{color:var(--accent)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>TESOURA - BANCO DE DADOS (GUARDIÃO)</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>PAINEL / ARQUIVO</label>
          <select id="selPainel">
            <option value="">Carregando…</option>
          </select>
        </div>
        <div class="col">
          <label>PERÍODO</label>
          <select id="selPeriodo" disabled>
            <option value="">Selecione o painel</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn btn-ok" id="btnCarregar" disabled>CARREGAR</button>
          <button class="btn btn-warn" id="btnLimpar">LIMPAR</button>
        </div>
      </div>

      <div class="status" id="statusLine">
        <b>Status:</b> <span id="statusTxt">iniciando…</span>
      </div>

      <div class="result" id="resultBox">
        <div class="small"><b>RESULTADO:</b> carregue um arquivo.</div>
      </div>

      <div class="downloads">
        <button class="btn btn-blue" id="btnPdf" disabled>BAIXAR PDF</button>
        <button class="btn btn-blue" id="btnCsv" disabled>BAIXAR CSV</button>
        <button class="btn btn-blue" id="btnXlsx" disabled>BAIXAR EXCEL</button>
      </div>

      <div class="foot">
        Banco de Dados é <b>somente leitura</b>: não edita, não salva e não exclui.
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // =========================
    // CONFIG SUPABASE (mesmo padrão do app)
    // =========================
    // Se você já usa config.js no app, pode manter aqui igual estava.
    // Mantive como no seu arquivo original para não quebrar o login.
    const SUPABASE_URL  = window.SUPABASE_URL  || "https://xuplzpsipukvtkggjasx.supabase.co";
    const SUPABASE_ANON = window.SUPABASE_ANON || "COLE_AQUI_SUA_ANON_KEY_SE_NAO_TIVER_NO_WINDOW";

    const tesouraSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // =========================
    // ELEMENTOS
    // =========================
    const elPainel   = document.getElementById("selPainel");
    const elPeriodo  = document.getElementById("selPeriodo");
    const btnCarregar= document.getElementById("btnCarregar");
    const btnLimpar  = document.getElementById("btnLimpar");

    const btnPdf  = document.getElementById("btnPdf");
    const btnCsv  = document.getElementById("btnCsv");
    const btnXlsx = document.getElementById("btnXlsx");

    const statusTxt = document.getElementById("statusTxt");
    const resultBox = document.getElementById("resultBox");

    // =========================
    // ESTADO
    // =========================
    let loadedRow = null;         // registro de arquivos_app
    let loadedRows = [];          // linhas do conteudo (array)
    let loadedCols = [];          // colunas (keys)

    // =========================
    // HELPERS
    // =========================
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function setStatus(msg, type){
      statusTxt.innerHTML = escapeHtml(msg);
      statusTxt.className = "";
      if(type==="ok") statusTxt.className="ok";
      if(type==="err") statusTxt.className="err";
      if(type==="warn") statusTxt.className="warn";
    }
    function resetLoaded(){
      loadedRow = null;
      loadedRows = [];
      loadedCols = [];
      btnPdf.disabled = true;
      btnCsv.disabled = true;
      btnXlsx.disabled = true;
      btnCarregar.disabled = true;
      resultBox.innerHTML = `<div class="small"><b>RESULTADO:</b> carregue um arquivo.</div>`;
    }

    // =========================
    // LISTAR PAINÉIS
    // =========================
    async function loadPainelOptions(){
      setStatus("carregando painéis…");

      const { data, error } = await tesouraSupabase
        .from("arquivos_app")
        .select("painel")
        .order("painel", { ascending: true });

      if(error){
        console.error("[BD] listar painéis:", error);
        setStatus("Erro ao listar painéis (ver Console).", "err");
        elPainel.innerHTML = `<option value="">(erro)</option>`;
        return;
      }

      // ✅ SEMPRE MOSTRAR PAINÉIS OFICIAIS (mesmo sem arquivo salvo)
      const FIXOS = ["jogadores","presenca","escalacao","controle_geral","mensalidade","caixa","gols"];
      const doBanco = [...new Set((data || []).map(x => x.painel).filter(Boolean))];

      const unique = [...new Set([...FIXOS, ...doBanco])];

      elPainel.innerHTML =
        `<option value="">Selecione…</option>` +
        unique.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

      setStatus("pronto. selecione um painel.");
    }

    // =========================
    // LISTAR PERÍODOS DO PAINEL
    // =========================
    async function loadPeriodoOptions(painel){
      resetLoaded();
      elPeriodo.disabled = true;
      elPeriodo.innerHTML = `<option value="">Carregando…</option>`;
      setStatus("carregando períodos…");

      const { data, error } = await tesouraSupabase
        .from("arquivos_app")
        .select("periodo")
        .eq("painel", painel)
        .order("periodo", { ascending: true });

      if(error){
        console.error("[BD] listar períodos:", error);
        setStatus("Erro ao listar períodos (ver Console).", "err");
        elPeriodo.innerHTML = `<option value="">(erro)</option>`;
        return;
      }

      const unique = [...new Set((data || []).map(x => x.periodo).filter(Boolean))];

      if(!unique.length){
        elPeriodo.disabled = true;
        elPeriodo.innerHTML = `<option value="">(sem arquivos)</option>`;
        setStatus("Sem arquivos salvos para este painel.", "warn");
        return;
      }

      elPeriodo.disabled = false;
      elPeriodo.innerHTML =
        `<option value="">Selecione…</option>` +
        unique.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

      setStatus("pronto. selecione o período.");
    }

    // =========================
    // CARREGAR ARQUIVO
    // =========================
    async function carregarArquivo(painel, periodo){
      resetLoaded();
      setStatus("carregando arquivo…");

      const { data, error } = await tesouraSupabase
        .from("arquivos_app")
        .select("id,painel,periodo,data_ref,mes_ref,ano_ref,titulo,conteudo,criado_em,created_at")
        .eq("painel", painel)
        .eq("periodo", periodo)
        .order("created_at", { ascending: false })
        .limit(1);

      if(error){
        console.error("[BD] carregar arquivo:", error);
        setStatus("Erro ao carregar arquivo do Banco de Dados.", "err");
        resultBox.innerHTML = `<div class="small"><b>RESULTADO:</b> erro ao carregar.</div>`;
        return;
      }

      const row = (data && data[0]) ? data[0] : null;
      if(!row){
        setStatus("Nenhum arquivo encontrado para este painel/período.", "warn");
        resultBox.innerHTML = `<div class="small"><b>RESULTADO:</b> nenhum arquivo.</div>`;
        return;
      }

      loadedRow = row;

      // Conteúdo deve ser JSON (array)
      let content = row.conteudo;
      try{
        if(typeof content === "string") content = JSON.parse(content);
      }catch(e){
        console.error("[BD] conteudo inválido:", e, row.conteudo);
        setStatus("Arquivo inválido (conteúdo não é JSON).", "err");
        resultBox.innerHTML = `<div class="small"><b>RESULTADO:</b> conteúdo inválido.</div>`;
        return;
      }

      if(!Array.isArray(content)){
        setStatus("Arquivo inválido (conteúdo não é lista).", "err");
        resultBox.innerHTML = `<div class="small"><b>RESULTADO:</b> conteúdo inválido.</div>`;
        return;
      }

      loadedRows = content;

      // Colunas (keys)
      const colsSet = new Set();
      for(const r of loadedRows){
        if(r && typeof r === "object"){
          Object.keys(r).forEach(k => colsSet.add(k));
        }
      }
      loadedCols = Array.from(colsSet);

      renderResult();

      btnPdf.disabled  = false;
      btnCsv.disabled  = false;
      btnXlsx.disabled = false;

      setStatus("Excel gerado.", "ok");
    }

    // =========================
    // RENDER
    // =========================
    function renderResult(){
      const row = loadedRow;
      const rows = loadedRows;

      const createdValue = (row.created_at || row.criado_em) || "-";

      let metaHtml = `
        <div class="meta">
          <div><span class="k">Painel:</span> ${escapeHtml(row.painel)}</div>
          <div><span class="k">Período:</span> ${escapeHtml(row.periodo)}</div>
          <div><span class="k">Título:</span> ${escapeHtml(row.titulo || "-")}</div>
        </div>
        <div class="meta">
          <div><span class="k">Data ref:</span> ${escapeHtml(row.data_ref ?? "-")}</div>
          <div><span class="k">Mês ref:</span> ${escapeHtml(row.mes_ref ?? "-")}</div>
          <div><span class="k">Ano ref:</span> ${escapeHtml(row.ano_ref ?? "-")}</div>
          <div><span class="k">Criado em:</span> ${escapeHtml(createdValue)}</div>
        </div>
        <hr style="border:0;border-top:1px solid #123a62;margin:12px 0"/>
        <div class="small muted">Prévia do conteúdo (primeiras 10 linhas):</div>
      `;

      const preview = rows.slice(0, 10);

      let table = `<div class="tableWrap"><table><thead><tr>${
        loadedCols.map(c => `<th>${escapeHtml(c)}</th>`).join("")
      }</tr></thead><tbody>${
        preview.map(r => `<tr>${
          loadedCols.map(c => `<td>${escapeHtml(r?.[c] ?? "")}</td>`).join("")
        }</tr>`).join("")
      }</tbody></table></div>`;

      resultBox.innerHTML = metaHtml + table;
    }

    // =========================
    // DOWNLOADS
    // =========================
    function downloadCSV(){
      if(!loadedRows.length) return;
      const cols = loadedCols;
      const lines = [];
      lines.push(cols.join(","));
      for(const r of loadedRows){
        const line = cols.map(c => {
          const v = (r && typeof r==="object") ? (r[c] ?? "") : "";
          const s = String(v).replaceAll('"','""');
          return `"${s}"`;
        }).join(",");
        lines.push(line);
      }
      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${loadedRow.painel}_${loadedRow.periodo}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function downloadXLSX(){
      if(!loadedRows.length) return;
      const ws = XLSX.utils.json_to_sheet(loadedRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "dados");
      XLSX.writeFile(wb, `${loadedRow.painel}_${loadedRow.periodo}.xlsx`);
    }

    function downloadPDF(){
      if(!loadedRows.length) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"a4"});

      doc.setFontSize(12);
      doc.text(`TESOURA - ${loadedRow.painel} (${loadedRow.periodo})`, 40, 35);
      doc.setFontSize(9);
      doc.text(`Título: ${loadedRow.titulo || "-"}`, 40, 52);

      const body = loadedRows.map(r => loadedCols.map(c => (r?.[c] ?? "")));

      doc.autoTable({
        head: [loadedCols],
        body,
        startY: 70,
        styles: { fontSize: 7 },
        headStyles: { fillColor: [7, 26, 45] },
        margin: { left: 30, right: 30 }
      });

      doc.save(`${loadedRow.painel}_${loadedRow.periodo}.pdf`);
    }

    // =========================
    // EVENTOS
    // =========================
    elPainel.addEventListener("change", async () => {
      const painel = elPainel.value;
      resetLoaded();

      if(!painel){
        elPeriodo.disabled = true;
        elPeriodo.innerHTML = `<option value="">Selecione o painel</option>`;
        setStatus("selecione um painel.", "warn");
        return;
      }
      await loadPeriodoOptions(painel);
    });

    elPeriodo.addEventListener("change", () => {
      const painel = elPainel.value;
      const periodo = elPeriodo.value;
      btnCarregar.disabled = !(painel && periodo);
    });

    btnCarregar.addEventListener("click", async () => {
      const painel = elPainel.value;
      const periodo = elPeriodo.value;
      if(!painel || !periodo) return;
      await carregarArquivo(painel, periodo);
    });

    btnLimpar.addEventListener("click", () => {
      elPainel.value = "";
      elPeriodo.disabled = true;
      elPeriodo.innerHTML = `<option value="">Selecione o painel</option>`;
      resetLoaded();
      setStatus("limpo. selecione um painel.");
    });

    btnCsv.addEventListener("click", downloadCSV);
    btnXlsx.addEventListener("click", downloadXLSX);
    btnPdf.addEventListener("click", downloadPDF);

    // =========================
    // START
    // =========================
    resetLoaded();
    loadPainelOptions();
  </script>
</body>
</html>
