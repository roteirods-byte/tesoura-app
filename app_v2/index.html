<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA — CONTROLE DO FUTEBOL</title>
  <link rel="stylesheet" href="./css/ui.css?v=2" />
  <link rel="stylesheet" href="./css/tesoura_shell.css?v=2" />
</head>
<body>
  <header class="topbar">
    <div class="brand">TESOURA — CONTROLE DO FUTEBOL</div>
    <div class="topbar-right">
      <span id="modePill" class="pill">Modo: —</span>
      <span id="buildPill" class="pill">BUILD: —</span>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="cardLogin">
      <h1>Entrar</h1>
      <p class="muted">Digite a senha e clique em ENTRAR.</p>

      <div class="grid">
        <div class="field">
          <label>TIPO DE ACESSO</label>
          <select id="selMode">
            <option value="diretoria">Diretoria</option>
            <option value="jogadores">Jogadores (visual)</option>
          </select>
        </div>

        <div class="field">
          <label>SENHA</label>
          <input id="txtPin" type="password" placeholder="Digite a senha" autocomplete="current-password" />
        </div>
      </div>

      <div class="actions">
        <button id="btnEnter" class="btn btn-ok">ENTRAR</button>
        <button id="btnClear" class="btn btn-warn">LIMPAR</button>
      </div>

      <div id="msg" class="msg"></div>
      <p class="hint">Dica: se abriu direto um painel, use o botão SAIR e volte aqui.</p>
    </section>

    <section class="card" id="cardMenu" style="display:none;">
      <h1>Painéis</h1>
      <p class="muted">Escolha o painel.</p>

      <div class="menu">
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_jogadores_teste.html">JOGADORES</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_presenca_escala_R5.html">PRESENÇA / ESCALAÇÃO</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_controle_geral_teste.html">CONTROLE GERAL</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_mensalidade_R4.html">MENSALIDADE</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_caixa_teste.html">CAIXA</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_gols_teste.html">GOLS</button>
        <button class="btn btn-pill" data-go="../app/legacy/tesoura_banco_dados_teste.html">BANCO DE DADOS</button>
      </div>

      <div class="actions" style="margin-top:14px;">
        <button id="btnLogout" class="btn btn-danger">SAIR</button>
      </div>
    </section>
  </main>

  <script src="./js/config.js?v=2"></script>
  <script src="./js/auth.js?v=2"></script>

  <script>
    (function () {
      const url = new URL(location.href);
      const BUILD = url.searchParams.get("build") || "v2";
      const msg = document.getElementById("msg");
      const selMode = document.getElementById("selMode");
      const txtPin = document.getElementById("txtPin");
      const btnEnter = document.getElementById("btnEnter");
      const btnClear = document.getElementById("btnClear");
      const cardLogin = document.getElementById("cardLogin");
      const cardMenu = document.getElementById("cardMenu");
      const btnLogout = document.getElementById("btnLogout");

      document.getElementById("buildPill").textContent = "BUILD: " + BUILD;

      function setMsg(text, kind) {
        msg.textContent = text || "";
        msg.className = "msg" + (kind ? (" " + kind) : "");
      }

      function setModePill() {
        document.getElementById("modePill").textContent =
          "Modo: " + (selMode.value === "diretoria" ? "Diretoria" : "Jogadores");
      }

      function showMenu() {
        cardLogin.style.display = "none";
        cardMenu.style.display = "";
      }
      function showLogin() {
        cardMenu.style.display = "none";
        cardLogin.style.display = "";
      }

      function onEnter() {
        setMsg("");
        const mode = (selMode.value || "").toLowerCase();
        const pin = (txtPin.value || "").trim();

        if (!pin) { setMsg("Digite a senha.", "err"); txtPin.focus(); return; }
        if (!window.TESOURA_AUTH || !window.TESOURA_AUTH.validatePin) {
          setMsg("Falha: auth.js não carregou.", "err"); return;
        }

        if (!window.TESOURA_AUTH.validatePin(mode, pin)) {
          setMsg("Senha inválida.", "err"); return;
        }

        localStorage.setItem("TESOURA_MODE", mode);
        localStorage.setItem("TESOURA_LOGIN_AT", String(Date.now()));
        setMsg("Entrando...", "ok");
        showMenu();
      }

      function hardLogout() {
        localStorage.removeItem("TESOURA_MODE");
        localStorage.removeItem("TESOURA_LOGIN_AT");
        txtPin.value = "";
        setMsg("");
        showLogin();
      }

      btnEnter.addEventListener("click", onEnter);
      txtPin.addEventListener("keydown", (e) => { if (e.key === "Enter") onEnter(); });
      btnClear.addEventListener("click", () => { txtPin.value=""; setMsg(""); txtPin.focus(); });

      // menu links
      document.querySelectorAll("[data-go]").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = (selMode.value || "diretoria").toLowerCase();
          const target = btn.getAttribute("data-go");
          const u = new URL(target, location.href);
          u.searchParams.set("build", BUILD);
          u.searchParams.set("mode", mode);
          // marca "retorno" para voltar pro menu (V2) via SAIR
          u.searchParams.set("return", "../app_v2/index.html?build=" + encodeURIComponent(BUILD));
          location.href = u.toString();
        });
      });

      btnLogout.addEventListener("click", hardLogout);

      // init
      setModePill();
      selMode.addEventListener("change", setModePill);

      // se já logado, abre menu
      const saved = (localStorage.getItem("TESOURA_MODE") || "").toLowerCase();
      if (saved === "diretoria" || saved === "jogadores") {
        selMode.value = saved;
        setModePill();
        showMenu();
      } else {
        showLogin();
        txtPin.focus();
      }
    })();
  </script>
</body>
</html>
