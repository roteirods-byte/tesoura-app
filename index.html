<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TESOURA - PAINÉIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Evitar cache do index -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    .topbar{background:#111827;padding:10px 20px;color:#ff7f27;font-weight:900;font-size:18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .topbar .actions{display:flex;align-items:center;gap:8px}
    .mode{font-size:12px;color:#fff;opacity:.9;background:#0b1220;border:1px solid #334155;padding:4px 8px;border-radius:999px}
    .topbar button{border:none;border-radius:6px;padding:6px 10px;font-weight:900;cursor:pointer}
    .btn-login{background:#0ea5e9;color:#06162f;display:none}
    .btn-logout{background:#ef4444;color:#fff;display:none}

    .tabs{display:flex;background:#111827;border-bottom:2px solid #ff7f27}
    .tab-btn{flex:1;padding:10px;cursor:pointer;text-align:center;border:none;background:#111827;color:#fff;font-weight:900;font-size:14px}
    .tab-btn.active{background:#1f2937;color:#ff7f27;border-bottom:3px solid #ff7f27}
    .tab-content{display:none;height:calc(100vh - 80px);background:#0b1220}
    .tab-content.active{display:block}
    iframe{width:100%;height:100%;border:none;background:#0b1220}

    /* Tela inicial */
    #telaInicial{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.80)}
    #telaInicial .box{width:min(520px,100%);background:#081427;border:1px solid #334155;border-radius:14px;padding:18px;text-align:center}
    #telaInicial .t1{color:#ff7f27;font-weight:900;font-size:22px}
    #telaInicial .t2{color:#e5e7eb;margin-top:8px;font-weight:800}
    #telaInicial .t3{color:#e5e7eb;margin-top:18px;font-weight:900}
    #telaInicial .row{display:flex;gap:14px;justify-content:center;margin-top:18px;flex-wrap:wrap}
    #telaInicial .btnJ{min-width:200px;border:none;border-radius:10px;padding:12px 14px;font-weight:900;cursor:pointer;background:#22c55e;color:#052e16}
    #telaInicial .btnD{min-width:200px;border:none;border-radius:10px;padding:12px 14px;font-weight:900;cursor:pointer;background:#3b82f6;color:#06162f}
    #telaInicial .msg{margin-top:12px;color:#e5e7eb;font-size:12px;min-height:16px}
    noscript{display:block;padding:12px;background:#b91c1c;color:#fff;font-weight:900;text-align:center}
  </style>

  <script>
    // ===== REGRAS DE ESTABILIDADE (SITE OFICIAL) =====
    // 1) Sempre mostrar a tela inicial (senha) ao abrir
    // 2) Iframes carregam sempre versão nova (cb automático)
    // 3) Desativar Service Worker (evita versão antiga em cache)

    function qs(id){ return document.getElementById(id); }
    function cacheBust(url){
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "cb=" + Date.now();
    }
    function showTelaInicial(v){
      const t = qs("telaInicial");
      if(t) t.style.display = v ? "flex" : "none";
    }
    function setBadge(txt){
      const b = qs("modeBadge");
      if(b) b.textContent = txt;
    }

    async function disableServiceWorker(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for(const r of regs){ await r.unregister(); }
        }
      }catch(e){}
      try{
        if("caches" in window){
          const keys = await caches.keys();
          for(const k of keys){ await caches.delete(k); }
        }
      }catch(e){}
    }

    // Entrar Jogadores
    function TESOURA_ENTRAR_JOGADORES(){
      const cfg = window.TESOURA_CONFIG || {};
      const pinCfg = String(cfg.APP_PIN || "").trim();
      const pin = (prompt("Senha dos JOGADORES (visualização):") || "").trim();
      if(pinCfg && pin !== pinCfg){
        qs("msgTelaInicial").textContent = "Senha incorreta.";
        return;
      }
      window.TESOURA_ROLE = "jogador";
      showTelaInicial(false);
      setBadge("Modo: Jogadores (visual)");
      abrirAba("aba-jogadores");
      setTimeout(()=>TESOURA_TRAVAR_IFRAMES(), 200);
    }

    // Entrar Diretoria
    function TESOURA_ENTRAR_DIRETORIA(){
      window.TESOURA_ROLE = "diretoria";
      showTelaInicial(false);
      setBadge("Modo: Diretoria");
      abrirAba("aba-jogadores");
    }

    // Trava cliques dentro do iframe (modo jogador)
    function travarIframeJogador(iframe){
      try{
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        if(!doc || !doc.body) return;

        let banner = doc.getElementById("TESOURA_JOGADOR_BANNER");
        if(!banner){
          banner = doc.createElement("div");
          banner.id = "TESOURA_JOGADOR_BANNER";
          banner.textContent = "MODO JOGADOR: SOMENTE VISUALIZAÇÃO";
          banner.style.cssText =
            "position:fixed;top:0;left:0;right:0;z-index:999999;" +
            "background:#b91c1c;color:#fff;font-weight:900;" +
            "padding:8px 10px;text-align:center;font-size:12px;";
          doc.body.appendChild(banner);
          doc.body.style.paddingTop = "40px";
        }

        let style = doc.getElementById("TESOURA_JOGADOR_LOCK");
        if(!style){
          style = doc.createElement("style");
          style.id = "TESOURA_JOGADOR_LOCK";
          style.textContent = `
            button, input, select, textarea, a, [role="button"], [onclick]{
              pointer-events:none !important;
              opacity:0.55 !important;
              cursor:not-allowed !important;
            }
          `;
          (doc.head || doc.documentElement).appendChild(style);
        }
      }catch(e){}
    }

    function TESOURA_TRAVAR_IFRAMES(){
      if(window.TESOURA_ROLE !== "jogador") return;
      document.querySelectorAll("iframe").forEach(ifr=>travarIframeJogador(ifr));
    }

    function ensureIframeLoaded(iframe){
      if(!iframe) return;
      const base = iframe.getAttribute("data-src");
      if(!base) return;

      // evita "flash" de versão antiga
      iframe.src = "about:blank";
      setTimeout(()=>{ iframe.src = cacheBust(base); }, 0);

      iframe.addEventListener("load", ()=>TESOURA_TRAVAR_IFRAMES(), { once:false });
    }

    function abrirAba(id){
      const abas = document.querySelectorAll(".tab-content");
      const botoes = document.querySelectorAll(".tab-btn");

      abas.forEach(a=>a.classList.remove("active"));
      botoes.forEach(b=>b.classList.remove("active"));

      const el = document.getElementById(id);
      if(el) el.classList.add("active");

      const map = {"aba-jogadores":0,"aba-presenca":1,"aba-controle":2,"aba-mensalidade":3,"aba-caixa":4,"aba-gols":5,"aba-banco":6};
      if(botoes[map[id]]) botoes[map[id]].classList.add("active");

      const iframe = document.querySelector("#"+id+" iframe");
      ensureIframeLoaded(iframe);
    }
    window.abrirAba = abrirAba;

    window.addEventListener("load", async ()=>{
      await disableServiceWorker();

      // SEMPRE mostrar a tela inicial ao abrir o site
      window.TESOURA_ROLE = "";
      showTelaInicial(true);
      setBadge("Modo: —");

      // carrega a primeira aba já com versão nova
      abrirAba("aba-jogadores");
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="app/js/supabaseClient.js"></script>
</head>

<body>

  <!-- LOGIN OVERLAY (Senha somente) -->
  <div id="tesouraLoginOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="width:min(520px,92vw);background:#020617;border:1px solid rgba(249,115,22,.35);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.55);padding:18px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;">
        <div style="color:#f97316;font-weight:800;letter-spacing:.5px;">TESOURA – ACESSO</div>
        <div id="tesouraLoginMsg" style="color:#f9fafb;font-size:12px;opacity:.85;"></div>
      </div>

      <div style="display:grid;gap:10px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="btnLoginJogadores" style="background:#0ea5e9;color:#022c22;border:none;border-radius:8px;padding:10px 12px;font-weight:800;cursor:pointer;min-width:160px;">ENTRAR (JOGADORES)</button>
          <button id="btnLoginDiretoria" style="background:#22c55e;color:#022c22;border:none;border-radius:8px;padding:10px 12px;font-weight:800;cursor:pointer;min-width:160px;">ENTRAR (DIRETORIA)</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <label style="color:#f9fafb;font-weight:700;">SENHA:</label>
          <input id="inpSenha" type="password" autocomplete="current-password"
                 style="flex:1;min-width:220px;background:#0b1220;border:1px solid rgba(249,115,22,.35);border-radius:8px;padding:10px;color:#f9fafb;outline:none;" />
          <button id="btnOkSenha" style="background:#f97316;color:#0b1220;border:none;border-radius:8px;padding:10px 12px;font-weight:900;cursor:pointer;">OK</button>
        </div>

        <div style="color:#94a3b8;font-size:12px;line-height:1.35;">
          • Jogadores: somente visualização.<br/>
          • Diretoria: acesso conforme senha (com ou sem Caixa).<br/>
          • Botão <b>SAIR</b> encerra a sessão e recarrega o site.
        </div>
      </div>
    </div>
  </div>

  <noscript>Ative o JavaScript no navegador para usar o TESOURA.</noscript>

  <!-- TELA INICIAL -->
  <div id="telaInicial">
    <div class="box">
      <div class="t1">GRUPO TESOURA I</div>
      <div class="t2">ESPORTE, FAMÍLIA E AMIZADE</div>
      <div class="t3">APLICATIVO DO GRUPO</div>

      <div class="row">
        <button class="btnJ" onclick="TESOURA_ENTRAR_JOGADORES()">ENTRAR JOGADORES</button>
        <button class="btnD" onclick="TESOURA_ENTRAR_DIRETORIA()">ENTRAR DIRETORIA</button>
      </div>

      <div class="msg" id="msgTelaInicial"></div>
    </div>
  </div>

  <div class="topbar">
    <div>TESOURA – CONTROLE DO FUTEBOL</div>
    <div class="actions">
      <div class="mode" id="modeBadge">Modo: —</div>
      <button class="btn-login" id="btnLogin">ENTRAR (DIRETORIA)</button>
      <button class="btn-logout" id="btnLogout">SAIR</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="abrirAba('aba-jogadores')">JOGADORES</button>
    <button class="tab-btn" onclick="abrirAba('aba-presenca')">PRESENÇA / ESCALAÇÃO</button>
    <button class="tab-btn" onclick="abrirAba('aba-controle')">CONTROLE GERAL</button>
    <button class="tab-btn" onclick="abrirAba('aba-mensalidade')">MENSALIDADE</button>
    <button class="tab-btn" onclick="abrirAba('aba-caixa')">CAIXA</button>
    <button class="tab-btn" onclick="abrirAba('aba-gols')">GOLS</button>
    <button class="tab-btn" onclick="abrirAba('aba-banco')">BANCO DE DADOS</button>
  </div>

  <div id="aba-jogadores" class="tab-content active">
    <iframe id="f-jogadores" data-src="tesoura_jogadores_teste.html"></iframe>
  </div>

  <div id="aba-presenca" class="tab-content">
    <iframe id="f-presenca" data-src="tesoura_presenca_escala_R5.html"></iframe>
  </div>

  <div id="aba-controle" class="tab-content">
    <iframe id="f-controle" data-src="tesoura_controle_geral_teste.html"></iframe>
  </div>

  <div id="aba-mensalidade" class="tab-content">
    <iframe id="f-mensalidade" data-src="tesoura_mensalidade_R4.html"></iframe>
  </div>

  <div id="aba-caixa" class="tab-content">
    <iframe id="f-caixa" data-src="tesoura_caixa_teste.html"></iframe>
  </div>

  <div id="aba-gols" class="tab-content">
    <iframe id="f-gols" data-src="tesoura_gols_teste.html"></iframe>
  </div>

  <div id="aba-banco" class="tab-content">
    <iframe id="f-banco" data-src="tesoura_banco_dados_teste.html"></iframe>
  </div>

  <!-- Config do app (PIN, URL/KEY do Supabase etc) -->
  <script src="app/js/config.js"></script>

<script>
/* TESOURA_LOGIN_V2 (20251225_pwonly) */
(function(){
  const STORAGE_KEY = "TESOURA_SESSION_V2";
  function $(id){ return document.getElementById(id); }
  function setMsg(t){ const el=$("tesouraLoginMsg"); if(el) el.textContent = t||""; }

  // Password map (senha -> {email, perfil})
  const DIR_MAP = {
    "1baidec": { email: "1baidec@gmail.com", perfil: "TUDO" },
    "2thiago": { email: "2thiago@gmail.com", perfil: "TUDO" },
    "3love":   { email: "3love@gmail.com",   perfil: "SEM_CAIXA" },
    "4le":     { email: "4le@gmail.com",     perfil: "SEM_CAIXA" },
    "5titi":   { email: "5titi@gmail.com",   perfil: "SEM_CAIXA" },
  };
  const JOGADORES_SENHA = "TESOURA2026";

  function getSess(){ try{ return JSON.parse(sessionStorage.getItem(STORAGE_KEY)||"null"); }catch(e){ return null; } }
  function setSess(obj){
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    localStorage.setItem("TESOURA_MODO", obj?.modo || "");
    localStorage.setItem("TESOURA_PERFIL", obj?.perfil || "");
  }
  function clearSess(){
    sessionStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem("TESOURA_MODO");
    localStorage.removeItem("TESOURA_PERFIL");
  }

  async function ensureSupabase(){
    if(!window.TESOURA_CONFIG || !window.TESOURA_CONFIG.SUPABASE_URL || !window.TESOURA_CONFIG.SUPABASE_KEY){
      throw new Error("Supabase não inicializado. Verifique app/js/config.js (SUPABASE_URL e SUPABASE_KEY).");
    }
    
    if(!window.supabaseClient) {
  if (typeof window.initSupabaseClient === "function") {
    window.supabaseClient = window.initSupabaseClient();
  } else if (typeof window.getSupabase === "function") {
    window.supabaseClient = window.getSupabase();
  }
}
    
    if(!window.supabaseClient) throw new Error("Supabase não inicializado. Verifique app/js/supabaseClient.js");
    return window.supabaseClient;
  }

  function showOverlay(show){ const ov=$("tesouraLoginOverlay"); if(ov) ov.style.display = show ? "flex" : "none"; }
  function showLogout(show){ const btn=document.getElementById("btnLogout"); if(btn) btn.style.display = show ? "inline-block" : "none"; }

  function setBadge(modo) {
    const badge = document.getElementById("modoBadge");
    if(badge) {
      badge.textContent = (modo === "DIRETORIA") ? "Modo: Diretoria" : "Modo: Jogadores";
      badge.style.display = "inline-block";
    }
  }

  function applyCacheBusterToIframes() {
    document.querySelectorAll("iframe[data-src]").forEach(ifr => {
      const base = ifr.getAttribute("data-src");
      if(!base) return;
      ifr.src = base + (base.includes("?") ? "&" : "?") + "v=" + Date.now();
    });
  }

  const origAbrirAba = window.abrirAba;
  if(typeof origAbrirAba === "function") {
    window.abrirAba = function(nome) {
      const r = origAbrirAba(nome);
      try {
        const ifr = document.querySelector("iframe.aba-ativa");
        if(ifr && ifr.dataset && ifr.dataset.src) {
          const base = ifr.dataset.src;
          ifr.src = base + (base.includes("?") ? "&" : "?") + "v=" + Date.now();
        }
      } catch(e) {}
      return r;
    }
  }

  async function loginJogadores(senha) {
    if(senha !== JOGADORES_SENHA) throw new Error("Senha de jogadores incorreta.");
    setSess({ modo:"JOGADORES", perfil:"LEITURA", ts:Date.now() });
    setBadge("JOGADORES");
    showOverlay(false);
    showLogout(true);
    try{ if(typeof window.travarIframeJogador==="function") window.travarIframeJogador(); }catch(e){}
    applyCacheBusterToIframes();
  }

  async function loginDiretoria(senha) {
    const info = DIR_MAP[senha];
    if(!info) throw new Error("Senha de diretoria inválida.");
    const sb = await ensureSupabase();
    const resp = await sb.auth.signInWithPassword({ email: info.email, password: senha });
    if(resp.error) throw resp.error;
    setSess({ modo:"DIRETORIA", perfil: info.perfil, email: info.email, ts:Date.now() });
    setBadge("DIRETORIA");
    showOverlay(false);
    showLogout(true);
    applyCacheBusterToIframes();
  }

  async function doLogout() {
    try{ if(window.supabaseClient) await window.supabaseClient.auth.signOut(); }catch(e){}
    clearSess();
    const base = location.origin + location.pathname;
    location.href = base + "?v=" + Date.now();
  }

  function boot() {
    showLogout(false);
    setMsg("");

    const btnJog = $("btnLoginJogadores");
    const btnDir = $("btnLoginDiretoria");
    const btnOk  = $("btnOkSenha");
    const inp    = $("inpSenha");
    let modePick = null; // "JOG" | "DIR"

    if(btnJog) btnJog.onclick = () => { modePick="JOG"; setMsg("Jogadores selecionado."); inp?.focus(); };
    if(btnDir) btnDir.onclick = () => { modePick="DIR"; setMsg("Diretoria selecionado."); inp?.focus(); };

    async function submit() {
      try {
        if(!modePick) throw new Error("Selecione Jogadores ou Diretoria.");
        const senha = (inp?.value || "").trim();
        if(!senha) throw new Error("Digite a senha.");
        setMsg("Verificando...");
        if(modePick==="JOG") await loginJogadores(senha);
        else await loginDiretoria(senha);
        setMsg("");
        if(inp) inp.value="";
      } catch(e) {
        console.error(e);
        setMsg(e?.message || "Erro no login.");
      }
    }

    if(btnOk) btnOk.onclick = submit;
    if(inp) inp.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") submit(); });

    const btnLogout = document.getElementById("btnLogout");
    if(btnLogout) btnLogout.onclick = doLogout;

    const sess = getSess();
    if(sess && sess.modo) {
      setBadge(sess.modo);
      showOverlay(false);
      showLogout(true);
      applyCacheBusterToIframes();
      try{ if(sess.modo==="JOGADORES" && typeof window.travarIframeJogador==="function") window.travarIframeJogador(); }catch(e){}
    } else {
      showOverlay(true);
    }
  }

  window.addEventListener("load", boot);
})();
</script>

</body>
</html>
