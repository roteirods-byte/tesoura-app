<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA — CONTROLE DO FUTEBOL</title>
  <link rel="stylesheet" href="app/css/tesoura_shell.css?v=2025-12-27_fix" />
  <style>
    /* fallback se o css não carregar */
    body{margin:0;background:#050b16;color:#e7eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{color:#ff7a1a;font-weight:800;letter-spacing:.5px}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:999px;padding:6px 10px;font-size:12px}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .label{font-size:12px;opacity:.85;margin:12px 0 6px}
    input{height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);color:#fff;padding:0 12px;min-width:260px;outline:none}
    button{height:40px;border-radius:10px;border:0;padding:0 14px;font-weight:800;cursor:pointer}
    .btnEnter{background:#14c26e;color:#06120b}
    .btnClear{background:#ff7a1a;color:#1b0f05}
    .msg{min-height:18px;margin-top:10px;font-size:13px;color:#ffb38a}
    .hint{margin-top:10px;font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">TESOURA — CONTROLE DO FUTEBOL</div>
    <div class="row">
      <div class="pill" id="pillMode">Modo: —</div>
      <div class="pill" id="pillBuild">BUILD: —</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 6px">Entrar</h2>
      <div style="opacity:.85;font-size:13px">Digite a senha e clique em ENTRAR.</div>

      <div class="label">SENHA</div>
      <div class="row">
        <input id="pin" type="password" inputmode="numeric" placeholder="Digite a senha" autocomplete="current-password" />
        <button id="btnEnter" class="btnEnter" type="button">ENTRAR</button>
        <button id="btnClear" class="btnClear" type="button">LIMPAR</button>
      </div>

      <div id="msg" class="msg"></div>

      <div class="hint">Dica: se abriu direto uma página do painel, use o botão SAIR e volte aqui.</div>
    </div>
  </div>

  <script>
  (function(){
    // 1) Evita travar por Service Worker antigo (cache).
    async function killSW(){
      try{
        if("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          for(const r of regs){ try{ await r.unregister(); }catch(e){} }
        }
      }catch(e){}
      try{
        if("caches" in window){
          const keys = await caches.keys();
          for(const k of keys){ try{ await caches.delete(k); }catch(e){} }
        }
      }catch(e){}
    }

    function qs(name){
      try{ return new URLSearchParams(location.search).get(name) || ""; }catch(e){ return ""; }
    }

    function setMsg(t){
      const el = document.getElementById("msg");
      if(el){ el.textContent = String(t||""); }
      else if(t){ try{ alert(t); }catch(e){} }
    }

    // 2) Configurações de senha: prioriza app/js/config.js (se existir), senão usa fallback.
    //    - Jogadores: TESOURA2026 (visual)
    //    - Diretoria: 1baidec / 2thiago / 3love / 4le / 5titi
    const DEFAULT_PIN_JOGADORES = "TESOURA2026";
    const DEFAULT_PINS_DIRETORIA = ["1baidec","2thiago","3love","4le","5titi"];

    function validatePin(pin){
      const p = String(pin||"").trim();
      if(!p) return {ok:false, role:""};

      // Se existir TESOURA_CONFIG.APP_PIN, usa como senha única (modo simples).
      // Caso contrário, usa as regras acima.
      const cfg = window.TESOURA_CONFIG || {};
      if(cfg.APP_PIN){
        if(p === String(cfg.APP_PIN)) return {ok:true, role:"jogadores"};
        return {ok:false, role:""};
      }

      if(p === DEFAULT_PIN_JOGADORES) return {ok:true, role:"jogadores"};
      if(DEFAULT_PINS_DIRETORIA.includes(p)) return {ok:true, role:"diretoria"};
      return {ok:false, role:""};
    }

    function saveSession(role){
      const sess = {
        role,
        ts: Date.now(),
        v: 1
      };
      try{ localStorage.setItem("TESOURA_SESSION", JSON.stringify(sess)); }catch(e){}
    }

    function buildHomeUrl(){
      // Página central (tabs) — se não existir, cai em Jogadores.
      // Ajuste aqui caso você mude o nome.
      const build = qs("build");
      const base = "legacy/tesoura_app_abas_R10.html";
      const fall = "legacy/tesoura_jogadores_teste.html";
      // tenta abrir a página central; se der 404, o usuário só verá erro no navegador,
      // então mantemos o fallback rápido via query.
      const target = base;
      const params = [];
      if(build) params.push("build="+encodeURIComponent(build));
      return target + (params.length? ("?"+params.join("&")) : "");
    }

    function goHome(){
      location.href = buildHomeUrl();
    }

    async function onLoad(){
      // atualiza pills
      const b = qs("build") || "—";
      const pMode = document.getElementById("pillMode");
      const pBuild = document.getElementById("pillBuild");
      if(pMode) pMode.textContent = "Modo: —";
      if(pBuild) pBuild.textContent = "BUILD: " + b;

      // mata SW antes para evitar carregar JS antigo
      await killSW();

      // logout => limpa sessão
      if(qs("logout")){
        try{ localStorage.removeItem("TESOURA_SESSION"); }catch(e){}
      }

      const pin = document.getElementById("pin");
      const btnEnter = document.getElementById("btnEnter");
      const btnClear = document.getElementById("btnClear");

      function doClear(){
        if(pin) pin.value = "";
        setMsg("");
        try{ pin && pin.focus(); }catch(e){}
      }

      function doEnter(){
        try{
          const v = validatePin(pin ? pin.value : "");
          if(!v.ok){
            setMsg("Senha incorreta.");
            return;
          }
          saveSession(v.role);
          setMsg("");
          goHome();
        }catch(err){
          // nunca deixa o botão “morrer”
          console.error(err);
          setMsg("Erro interno no login (veja o Console).");
        }
      }

      if(btnClear) btnClear.addEventListener("click", doClear);
      if(btnEnter) btnEnter.addEventListener("click", doEnter);
      if(pin) pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); doEnter(); }});

      // foco
      try{ pin && pin.focus(); }catch(e){}
    }

    // garante DOM pronto
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", onLoad);
    else onLoad();
  })();
  </script>

  <!-- (Opcional) Se existir este arquivo, ele só define TESOURA_CONFIG; não quebra se faltar. -->
  <script src="app/js/config.js?v=2025-12-27_fix" defer></script>
</body>
</html>
