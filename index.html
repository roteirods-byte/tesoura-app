<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <title>TESOURA - CONTROLE DO FUTEBOL</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#0b1220;
      --line:#1f2a44;
      --text:#f9fafb;
      --muted:#94a3b8;
      --orange:#f97316;
      --green:#22c55e;
      --blue:#60a5fa;
      --red:#ef4444;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      padding:14px 18px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
      border-bottom:2px solid var(--orange);
      background: #07101f;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .hdr-left{ display:flex; gap:14px; align-items:center; }
    .brand{ color:var(--orange); font-size:18px; }
    .hdr-right{ display:flex; align-items:center; gap:10px; }
    .badge{
      font-size:12px;
      background:#0f1b33;
      border:1px solid #223055;
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      font-weight:700;
    }
    .btn-sair{
      background: var(--red);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
    }

    nav{
      display:flex;
      gap:12px;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background:#07101f;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab-btn{
      background:transparent;
      border:none;
      color: var(--text);
      font-weight:900;
      cursor:pointer;
      padding:10px 12px;
      border-radius:10px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .tab-btn.active{
      color: var(--orange);
      background:#0f1b33;
      outline:1px solid #223055;
    }

    main{ padding:0; }
    .tab-content{ display:none; position:relative; height: calc(100vh - 112px); }
    .tab-content.active{ display:block; }
    .tab-content iframe{
      width:100%;
      height:100%;
      border:0;
      background: var(--panel2);
    }
    .iframe-loader{
      position:absolute;
      left:0; right:0;
      top:16px;
      text-align:center;
      color:var(--text);
      font-weight:900;
      opacity:.9;
      pointer-events:none;
    }

    /* ===== Modal ===== */
    #login-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index:9999;
    }
    .login-box{
      width:min(760px, 92vw);
      background:#0b1730;
      border:2px solid #223055;
      border-radius:16px;
      padding:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .login-title{ color:var(--orange); font-weight:900; font-size:18px; margin-bottom:10px; letter-spacing:1px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn-choice{
      border:none; cursor:pointer; font-weight:900; text-transform:uppercase;
      padding:10px 14px; border-radius:10px;
    }
    .btn-jog{ background:var(--blue); color:#0b1220; }
    .btn-dir{ background:var(--green); color:#0b1220; }
    .btn-choice.active{ outline:2px solid var(--orange); outline-offset:2px; }
    .inp{
      flex:1;
      min-width:240px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223055;
      background:#07101f;
      color:var(--text);
      font-weight:900;
    }
    .btn-ok{ background:var(--orange); color:#0b1220; border:none; border-radius:10px; padding:10px 14px; font-weight:900; cursor:pointer; }
    .hint{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35; }
    .hint b{ color:var(--text); }
  </style>
</head>

<body>
  <header>
    <div class="hdr-left">
      <div class="brand">TESOURA – CONTROLE DO FUTEBOL</div>
    </div>
    <div class="hdr-right">
      <div id="lbl-modo" class="badge">Modo: —</div>
      <button id="btn-sair" class="btn-sair" type="button">SAIR</button>
    </div>
  </header>

  <nav>
    <button class="tab-btn active" data-tab="jogadores">JOGADORES</button>
    <button class="tab-btn" data-tab="presenca">PRESENÇA / ESCALAÇÃO</button>
    <button class="tab-btn" data-tab="controle">CONTROLE GERAL</button>
    <button class="tab-btn" data-tab="mensalidade">MENSALIDADE</button>
    <button id="tab-caixa" class="tab-btn" data-tab="caixa">CAIXA</button>
    <button class="tab-btn" data-tab="gols">GOLS</button>
    <button class="tab-btn" data-tab="banco">BANCO DE DADOS</button>
  </nav>

  <main>
    <div id="aba-jogadores" class="tab-content active">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-jogadores" data-src="tesoura_jogadores_teste.html"></iframe>
    </div>

    <div id="aba-presenca" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-presenca" data-src="tesoura_presenca_escala_R5.html"></iframe>
    </div>

    <div id="aba-controle" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-controle" data-src="tesoura_controle_geral_teste.html"></iframe>
    </div>

    <div id="aba-mensalidade" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-mensalidade" data-src="tesoura_mensalidade_R4.html"></iframe>
    </div>

    <div id="aba-caixa" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-caixa" data-src="tesoura_caixa_teste.html"></iframe>
    </div>

    <div id="aba-gols" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-gols" data-src="tesoura_gols_teste.html"></iframe>
    </div>

    <div id="aba-banco" class="tab-content">
      <div class="iframe-loader" style="display:none;"></div>
      <iframe id="f-banco" data-src="tesoura_banco_dados_teste.html"></iframe>
    </div>
  </main>

  <!-- Modal Login -->
  <div id="login-modal">
    <div class="login-box">
      <div class="login-title">TESOURA — ACESSO</div>

      <div class="row" style="margin-bottom:10px;">
        <button id="btn-entrar-jogadores" class="btn-choice btn-jog active" type="button">ENTRAR (JOGADORES)</button>
        <button id="btn-entrar-diretoria" class="btn-choice btn-dir" type="button">ENTRAR (DIRETORIA)</button>
      </div>

      <div class="row">
        <div style="min-width:64px;font-weight:900;">SENHA:</div>
        <input id="login-senha" class="inp" type="password" placeholder="Digite a senha e aperte Enter" />
        <button id="btn-login-ok" class="btn-ok" type="button">OK</button>
      </div>

      <div class="hint">
        • Jogadores: somente visualização (senha única).<br/>
        • Diretoria: acesso conforme senha (com ou sem Caixa).<br/>
        • Botão <b>SAIR</b> encerra a sessão e recarrega o acesso.
      </div>
    </div>
  </div>

<script>
/* TESOURA_INDEX_STABLE build=20251226180055
   - Sem Service Worker (remove e limpa cache)
   - Iframe inteligente (root vs legacy) + detecta 404 e não deixa "piscar"
   - Cache-buster em toda troca de aba
*/
(function(){
  const BUILD = "20251226180055";
  const STORAGE_KEY = "TESOURA_SESSION_V2";

  // ===== Cache: desativa SW + limpa caches (best-effort) =====
  async function disableServiceWorker(){
    try{
      if("serviceWorker" in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        for(const r of regs){ try{ await r.unregister(); }catch(e){} }
      }
    }catch(e){}
    try{
      if("caches" in window){
        const keys = await caches.keys();
        for(const k of keys){ try{ await caches.delete(k); }catch(e){} }
      }
    }catch(e){}
  }
  disableServiceWorker();

  function $(id){ return document.getElementById(id); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  // ===== Senhas =====
  const SENHA_JOGADORES = "TESOURA2026";
  const DIRETORIA = {
    "1baidec": { canCaixa: true },
    "2thiago": { canCaixa: true },
    "3love":   { canCaixa: false },
    "4le":     { canCaixa: false },
    "5titi":   { canCaixa: false },
  };

  // ===== Sessão =====
  function setSession(sess){ localStorage.setItem(STORAGE_KEY, JSON.stringify(sess)); }
  function getSession(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }catch(e){ return null; } }
  function clearSession(){ localStorage.removeItem(STORAGE_KEY); }

  // ===== UI =====
  const modal = $("login-modal");
  const senhaInput = $("login-senha");
  const btnJog = $("btn-entrar-jogadores");
  const btnDir = $("btn-entrar-diretoria");
  const btnOk = $("btn-login-ok");
  const lblModo = $("lbl-modo");
  const btnSair = $("btn-sair");

  let selectedRole = "jogadores";

  function showModal(){ modal.style.display="flex"; senhaInput.value=""; setTimeout(()=>senhaInput.focus(),50); }
  function hideModal(){ modal.style.display="none"; }

  function setRole(role){
    selectedRole = role;
    btnJog.classList.toggle("active", role==="jogadores");
    btnDir.classList.toggle("active", role==="diretoria");
  }

  function updateHeader(sess){
    if(!sess) lblModo.textContent = "Modo: —";
    else lblModo.textContent = (sess.role==="diretoria") ? "Modo: Diretoria" : "Modo: Jogadores";
  }

  function applyPermissions(sess){
    const tabCaixaBtn = $("tab-caixa");
    const abaCaixa = $("aba-caixa");
    const isDir = sess?.role === "diretoria";
    const canCaixa = isDir ? !!sess.canCaixa : false;
    if(isDir && !canCaixa){
      tabCaixaBtn.style.display = "none";
      if(abaCaixa.classList.contains("active")) showTab("jogadores", true);
    } else {
      tabCaixaBtn.style.display = "";
    }
  }

  function doLogin(){
    const senha = (senhaInput.value||"").trim();
    if(!senha) return alert("Digite a senha.");

    if(selectedRole === "jogadores"){
      if(senha !== SENHA_JOGADORES) return alert("Senha de JOGADORES inválida.");
      const sess = { role:"jogadores", canCaixa:false, ts:Date.now(), build:BUILD };
      setSession(sess);
      updateHeader(sess);
      applyPermissions(sess);
      hideModal();
      showTab("jogadores", true);
      return;
    }

    const perm = DIRETORIA[senha];
    if(!perm) return alert("Senha de DIRETORIA inválida.");
    const sess = { role:"diretoria", canCaixa:!!perm.canCaixa, ts:Date.now(), build:BUILD };
    setSession(sess);
    updateHeader(sess);
    applyPermissions(sess);
    hideModal();
    showTab("jogadores", true);
  }

  btnJog.addEventListener("click", ()=>setRole("jogadores"));
  btnDir.addEventListener("click", ()=>setRole("diretoria"));
  btnOk.addEventListener("click", doLogin);
  senhaInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  btnSair.addEventListener("click", ()=>{
    clearSession();
    updateHeader(null);
    // reset iframes
    qsa("iframe[data-src]").forEach(ifr=>{ ifr.removeAttribute("src"); ifr.dataset.loaded=""; });
    showModal();
  });

  // ===== Tabs =====
  function setActiveTabButton(name){
    qsa(".tab-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  }
  function setActiveTabContent(name){
    qsa(".tab-content").forEach(div=>div.classList.toggle("active", div.id==="aba-"+name));
  }

  function isGitHub404(doc){
    try{
      const t = (doc.title||"").toLowerCase();
      const txt = (doc.body?.innerText||"").toLowerCase();
      if(t.includes("404") || txt.includes("file not found") || txt.includes("404")){
        if(txt.includes("github") || txt.includes("site configured at this address") || txt.includes("the requested file")) return true;
      }
    }catch(e){}
    return false;
  }

  function withCacheBust(url){
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "v=" + encodeURIComponent(BUILD + "-" + Date.now());
  }

  function getLoader(iframe){
    const wrap = iframe.parentElement;
    return wrap ? wrap.querySelector(".iframe-loader") : null;
  }

  function loadOne(iframe, url, timeoutMs=8000){
    return new Promise((resolve)=>{
      let done=false;
      const timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); resolve({ok:false, reason:"timeout"}); }, timeoutMs);

      function cleanup(){
        iframe.removeEventListener("load", onLoad);
        iframe.removeEventListener("error", onErr);
        clearTimeout(timer);
      }
      function onErr(){
        if(done) return;
        done=true; cleanup();
        resolve({ok:false, reason:"error"});
      }
      function onLoad(){
        setTimeout(()=>{
          if(done) return;
          done=true; cleanup();
          try{
            const doc = iframe.contentDocument;
            if(doc && isGitHub404(doc)) return resolve({ok:false, reason:"404"});
          }catch(e){}
          resolve({ok:true});
        }, 50);
      }

      iframe.addEventListener("load", onLoad);
      iframe.addEventListener("error", onErr);

      iframe.src = withCacheBust(url);
    });
  }

  async function loadIframeSmart(iframe, forceReload){
    const raw = (iframe.dataset.src||"").trim();
    if(!raw) return;

    if(!forceReload && iframe.dataset.loaded==="1") return;

    const loader = getLoader(iframe);
    if(loader){ loader.textContent="Carregando painel..."; loader.style.display="block"; }

    iframe.style.visibility="hidden";

    const candidates=[];
    const add=(u)=>{ if(u && !candidates.includes(u)) candidates.push(u); };
    add(raw);
    if(raw.startsWith("legacy/")) add(raw.replace(/^legacy\//,""));
    else add("legacy/"+raw);

    for(const u of candidates){
      const res = await loadOne(iframe, u);
      if(res.ok){
        iframe.dataset.loaded="1";
        if(loader) loader.style.display="none";
        iframe.style.visibility="visible";
        return;
      }
    }

    if(loader) loader.textContent="Não foi possível carregar este painel (arquivo não encontrado).";
    iframe.style.visibility="hidden";
  }

  function showTab(name, forceReload){
    setActiveTabButton(name);
    setActiveTabContent(name);

    const iframe = $("f-"+name);
    if(!iframe) return;
    loadIframeSmart(iframe, !!forceReload);
  }

  // click tabs
  qsa(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const sess = getSession();
      if(!sess) return showModal();
      showTab(btn.dataset.tab, false);
    });
  });

  // ===== Boot =====
  (function init(){
    setRole("jogadores");
    const sess = getSession();
    if(sess){
      updateHeader(sess);
      applyPermissions(sess);
      hideModal();
      showTab("jogadores", true);
    } else {
      updateHeader(null);
      showModal();
      // NÃO carrega nenhum iframe antes de logar (evita mostrar 404 atrás do modal)
      qsa("iframe[data-src]").forEach(ifr=>{ ifr.removeAttribute("src"); ifr.dataset.loaded=""; });
    }
  })();
})();
</script>

</body>
</html>
