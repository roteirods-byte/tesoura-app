<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TESOURA - PAINÉIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Evitar cache do index -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b1220;color:#fff}
    .topbar{background:#111827;padding:10px 20px;color:#ff7f27;font-weight:900;font-size:18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .topbar .actions{display:flex;align-items:center;gap:8px}
    .mode{font-size:12px;color:#fff;opacity:.9;background:#0b1220;border:1px solid #334155;padding:4px 8px;border-radius:999px}
    .topbar button{border:none;border-radius:6px;padding:6px 10px;font-weight:900;cursor:pointer}
    .btn-login{background:#0ea5e9;color:#06162f;display:none}
    .btn-logout{background:#ef4444;color:#fff;display:none}

    .tabs{display:flex;background:#111827;border-bottom:2px solid #ff7f27}
    .tab-btn{flex:1;padding:10px;cursor:pointer;text-align:center;border:none;background:#111827;color:#fff;font-weight:900;font-size:14px}
    .tab-btn.active{background:#1f2937;color:#ff7f27;border-bottom:3px solid #ff7f27}
    .tab-content{display:none;height:calc(100vh - 80px);background:#0b1220}
    .tab-content.active{display:block}
    iframe{width:100%;height:100%;border:none;background:#0b1220}

    /* Tela inicial */
    #telaInicial{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.80)}
    #telaInicial .box{width:min(520px,100%);background:#081427;border:1px solid #334155;border-radius:14px;padding:18px;text-align:center}
    #telaInicial .t1{color:#ff7f27;font-weight:900;font-size:22px}
    #telaInicial .t2{color:#e5e7eb;margin-top:8px;font-weight:800}
    #telaInicial .t3{color:#e5e7eb;margin-top:18px;font-weight:900}
    #telaInicial .row{display:flex;gap:14px;justify-content:center;margin-top:18px;flex-wrap:wrap}
    #telaInicial .btnJ{min-width:200px;border:none;border-radius:10px;padding:12px 14px;font-weight:900;cursor:pointer;background:#22c55e;color:#052e16}
    #telaInicial .btnD{min-width:200px;border:none;border-radius:10px;padding:12px 14px;font-weight:900;cursor:pointer;background:#3b82f6;color:#06162f}
    #telaInicial .msg{margin-top:12px;color:#e5e7eb;font-size:12px;min-height:16px}
    noscript{display:block;padding:12px;background:#b91c1c;color:#fff;font-weight:900;text-align:center}
  </style>

  <script>
(() => {
  // ===== CONFIG / STATE =====
  const ROLE_KEY = "TESOURA_ROLE";
  const USER_KEY = "TESOURA_USER_ID";
  const MODE_BADGE = document.getElementById("modeBadge");
  const BTN_LOGIN = document.getElementById("btnLogin");
  const BTN_LOGOUT = document.getElementById("btnLogout");
  const TELA_INICIAL = document.getElementById("telaInicial");
  const FRAME = document.getElementById("appFrame");
  const SPINNER = document.getElementById("loadingOverlay");

  const CONFIG = window.TESOURA_CONFIG || {};
  const APP_PIN = (CONFIG.APP_PIN || "").trim();

  // Supabase (Diretoria)
  const SUPA = (window.supabase && typeof window.supabase.createClient === "function" && CONFIG.SUPABASE_URL && CONFIG.SUPABASE_KEY)
    ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY)
    : null;

  const TABS = [
    { id: "tab-jogadores",     src: "tesoura_jogadores_teste.html",      label: "JOGADORES" },
    { id: "tab-presenca",      src: "tesoura_presenca_escala_R5.html",   label: "PRESENÇA / ESCALAÇÃO" },
    { id: "tab-controle",      src: "tesoura_controle_geral_teste.html", label: "CONTROLE GERAL" },
    { id: "tab-mensalidade",   src: "tesoura_mensalidade_teste.html",    label: "MENSALIDADE" },
    { id: "tab-caixa",         src: "tesoura_caixa_teste.html",          label: "CAIXA" },
    { id: "tab-gols",          src: "tesoura_gols_teste.html",           label: "GOLS" },
    { id: "tab-banco",         src: "tesoura_banco_dados_teste.html",    label: "BANCO DE DADOS" },
  ];

  function cacheBust(url) {
    // força recarregar SEM cache, sem mudar o caminho
    const u = new URL(url, window.location.href);
    u.searchParams.set("v", Date.now().toString());
    return u.toString();
  }

  function setRole(role, userId = "") {
    localStorage.setItem(ROLE_KEY, role);
    if (userId) localStorage.setItem(USER_KEY, userId);
    else localStorage.removeItem(USER_KEY);
  }

  function getRole() {
    return (localStorage.getItem(ROLE_KEY) || "").trim();
  }

  function setUIForRole(role) {
    if (role === "diretoria") MODE_BADGE.textContent = "Modo: Diretoria";
    else if (role === "jogadores") MODE_BADGE.textContent = "Modo: Jogadores";
    else MODE_BADGE.textContent = "";

    // Botões do topo
    if (role) {
      BTN_LOGIN.textContent = "TROCAR";
      BTN_LOGOUT.style.display = "inline-flex"; // mostra SAIR
    } else {
      BTN_LOGIN.textContent = "ENTRAR";
      BTN_LOGOUT.style.display = "none";
    }
  }

  function showTelaInicial(show) {
    if (show) TELA_INICIAL.classList.add("active");
    else TELA_INICIAL.classList.remove("active");
  }

  function markActiveTab(tabId) {
    TABS.forEach(t => {
      const el = document.getElementById(t.id);
      if (!el) return;
      if (t.id === tabId) el.classList.add("active");
      else el.classList.remove("active");
    });
  }

  function ensureIframeLoaded(url) {
    return new Promise((resolve) => {
      SPINNER.classList.add("show");

      // evita "flash" do painel anterior
      FRAME.style.visibility = "hidden";
      FRAME.style.pointerEvents = "none";

      // garante reset real
      FRAME.src = "about:blank";

      // pequeno delay para aplicar o blank antes
      setTimeout(() => {
        FRAME.onload = () => {
          SPINNER.classList.remove("show");
          FRAME.style.visibility = "visible";
          FRAME.style.pointerEvents = "auto";
          resolve();
        };
        FRAME.src = cacheBust(url);
      }, 60);
    });
  }

  async function abrirAba(tabId) {
    const role = getRole();
    if (!role) {
      showTelaInicial(true);
      return;
    }

    const tab = TABS.find(t => t.id === tabId) || TABS[0];
    markActiveTab(tab.id);
    await ensureIframeLoaded(tab.src);
  }

  // ===== LOGIN FLOWS =====
  window.TESOURA_ENTRAR_JOGADORES = async function() {
    const senha = (prompt("Senha dos Jogadores:") || "").trim();
    if (!senha) return;

    if (senha !== APP_PIN) {
      alert("Senha inválida.");
      return;
    }

    setRole("jogadores");
    setUIForRole("jogadores");
    showTelaInicial(false);
    await abrirAba("tab-jogadores");
  };

  window.TESOURA_ENTRAR_DIRETORIA = async function() {
    if (!SUPA) {
      alert("Supabase não inicializado. Verifique app/js/config.js (SUPABASE_URL e SUPABASE_KEY).");
      return;
    }

    const email = (prompt("Email da Diretoria:") || "").trim();
    if (!email) return;

    const senha = (prompt("Senha da Diretoria:") || "").trim();
    if (!senha) return;

    const { data, error } = await SUPA.auth.signInWithPassword({ email, password: senha });
    if (error || !data || !data.user) {
      alert("Login inválido. Confira email/senha.");
      return;
    }

    setRole("diretoria", data.user.id);
    setUIForRole("diretoria");
    showTelaInicial(false);
    await abrirAba("tab-jogadores");
  };

  async function sairERecarregar() {
    // limpa role e sessão
    localStorage.removeItem(ROLE_KEY);
    localStorage.removeItem(USER_KEY);

    if (SUPA) {
      try { await SUPA.auth.signOut(); } catch(e) {}
    }

    // recarrega o site inteiro (mais seguro contra cache)
    const base = window.location.pathname;
    window.location.href = base + "?v=" + Date.now();
  }

  // ===== EVENTS =====
  BTN_LOGIN.addEventListener("click", () => {
    showTelaInicial(true);
  });

  BTN_LOGOUT.addEventListener("click", () => {
    sairERecarregar();
  });

  TABS.forEach(t => {
    const el = document.getElementById(t.id);
    if (!el) return;
    el.addEventListener("click", () => abrirAba(t.id));
  });

  // ===== BOOT =====
  (async function boot() {
    // se tiver role salva, mantém (celular)
    const role = getRole();
    setUIForRole(role);

    if (!role) {
      showTelaInicial(true);
      return;
    }

    showTelaInicial(false);
    await abrirAba("tab-jogadores");
  })();
})();
</script>
</head>

<body>
  <noscript>Ative o JavaScript no navegador para usar o TESOURA.</noscript>

  <!-- TELA INICIAL -->
  <div id="telaInicial">
    <div class="box">
      <div class="t1">GRUPO TESOURA I</div>
      <div class="t2">ESPORTE, FAMÍLIA E AMIZADE</div>
      <div class="t3">APLICATIVO DO GRUPO</div>

      <div class="row">
        <button class="btnJ" onclick="TESOURA_ENTRAR_JOGADORES()">ENTRAR JOGADORES</button>
        <button class="btnD" onclick="TESOURA_ENTRAR_DIRETORIA()">ENTRAR DIRETORIA</button>
      </div>

      <div class="msg" id="msgTelaInicial"></div>
    </div>
  </div>

  <div class="topbar">
    <div>TESOURA – CONTROLE DO FUTEBOL</div>
    <div class="actions">
      <div class="mode" id="modeBadge">Modo: —</div>
      <button class="btn-login" id="btnLogin">ENTRAR (DIRETORIA)</button>
      <button class="btn-logout" id="btnLogout">SAIR</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="abrirAba('aba-jogadores')">JOGADORES</button>
    <button class="tab-btn" onclick="abrirAba('aba-presenca')">PRESENÇA / ESCALAÇÃO</button>
    <button class="tab-btn" onclick="abrirAba('aba-controle')">CONTROLE GERAL</button>
    <button class="tab-btn" onclick="abrirAba('aba-mensalidade')">MENSALIDADE</button>
    <button class="tab-btn" onclick="abrirAba('aba-caixa')">CAIXA</button>
    <button class="tab-btn" onclick="abrirAba('aba-gols')">GOLS</button>
    <button class="tab-btn" onclick="abrirAba('aba-banco')">BANCO DE DADOS</button>
  </div>

  <div id="aba-jogadores" class="tab-content active">
    <iframe id="f-jogadores" data-src="tesoura_jogadores_teste.html"></iframe>
  </div>

  <div id="aba-presenca" class="tab-content">
    <iframe id="f-presenca" data-src="tesoura_presenca_escala_R5.html"></iframe>
  </div>

  <div id="aba-controle" class="tab-content">
    <iframe id="f-controle" data-src="tesoura_controle_geral_teste.html"></iframe>
  </div>

  <div id="aba-mensalidade" class="tab-content">
    <iframe id="f-mensalidade" data-src="tesoura_mensalidade_R4.html"></iframe>
  </div>

  <div id="aba-caixa" class="tab-content">
    <iframe id="f-caixa" data-src="tesoura_caixa_teste.html"></iframe>
  </div>

  <div id="aba-gols" class="tab-content">
    <iframe id="f-gols" data-src="tesoura_gols_teste.html"></iframe>
  </div>

  <div id="aba-banco" class="tab-content">
    <iframe id="f-banco" data-src="tesoura_banco_dados_teste.html"></iframe>
  </div>

  <!-- Config do app (PIN, URL/KEY do Supabase etc) -->
  <script src="app/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
