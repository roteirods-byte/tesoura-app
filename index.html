<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TESOURA — CONTROLE DO FUTEBOL</title>

  <!-- Tema do app (se existir no seu repo) -->
  <link rel="stylesheet" href="css/tesoura_shell.css?v=20251227_1" />
  <link rel="stylesheet" href="css/ui.css?v=20251227_1" />

  <style>
    body{background:linear-gradient(180deg,#050a18,#071225 40%,#06122a); color:#e8eefc; margin:0;}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;}
    .top{position:sticky;top:0;z-index:99;background:rgba(5,10,24,.92);border-bottom:1px solid rgba(255,140,0,.35);backdrop-filter:blur(6px);}
    .brand{font-weight:900;letter-spacing:.5px;color:#ff8c00}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:800;font-size:12px}
    .card{margin-top:28px;max-width:720px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);box-shadow:0 10px 40px rgba(0,0,0,.35);padding:18px}
    h1{margin:0 0 6px 0}
    label{display:block;font-weight:800;margin:10px 0 6px}
    input,select{width:100%;max-width:520px;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#e8eefc;outline:none}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);font-weight:900;cursor:pointer}
    .ok{background:rgba(0,255,120,.18);border-color:rgba(0,255,120,.35);color:#cffff0}
    .warn{background:rgba(255,140,0,.18);border-color:rgba(255,140,0,.35);color:#ffe7c6}
    #msg{margin-top:10px;font-weight:900;display:none}
    .hint{margin-top:8px;opacity:.9}
  </style>
</head>

<body>
  <div class="top">
    <div class="wrap">
      <div class="row">
        <div class="brand">TESOURA — CONTROLE DO FUTEBOL</div>
        <div style="margin-left:auto" class="row">
          <div class="badge" id="modeBadge">Modo: —</div>
          <div class="badge" id="buildBadge">BUILD: —</div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Entrar</h1>
      <div class="hint">Digite a senha e clique em ENTRAR.</div>

      <label for="mode">TIPO DE ACESSO</label>
      <select id="mode">
        <option value="Jogadores (visual)">Jogador</option>
        <option value="Diretoria">Diretoria</option>
      </select>

      <label for="pin">SENHA</label>
      <input id="pin" type="password" placeholder="Digite a senha" autocomplete="current-password" />

      <div class="btns">
        <button class="ok" id="btnEnter" type="button">ENTRAR</button>
        <button class="warn" id="btnClear" type="button">LIMPAR</button>
      </div>

      <div id="msg"></div>

      <div class="hint">Dica: se abriu direto um painel, use o botão SAIR e volte aqui.</div>
    </div>
  </div>

  <!-- Config (se existir no seu repo) -->
  <script src="js/config.js?v=20251227_1"></script>

  <script>
    (function(){
      "use strict";

      // ====== BASE (conserta seu erro: BASE is not defined) ======
      function getBasePath(){
        const p = location.pathname || "/";
        // se já termina com "/", mantém; senão remove o nome do arquivo
        return p.endsWith("/") ? p : p.replace(/\/[^\/]*$/, "/");
      }
      const BASE_PATH = getBasePath();                // ex: /tesoura-app/
      const BASE = location.origin + BASE_PATH;       // ex: https://roteirods-byte.github.io/tesoura-app/
      window.BASE_PATH = BASE_PATH;
      window.BASE = BASE;

      // ====== parâmetros ======
      function qp(name){
        try{ return new URLSearchParams(location.search).get(name); }catch(e){ return null; }
      }
      const LS_BUILD = "TESOURA_BUILD";
      function getBuild(){
        const b = qp("build") || localStorage.getItem(LS_BUILD) || "";
        if(b) localStorage.setItem(LS_BUILD, b);
        return b;
      }
      function buildQS(){
        const b = getBuild();
        return b ? ("?build=" + encodeURIComponent(b)) : "";
      }

      // ====== mensagens ======
      function setMsg(txt, isErr){
        const el = document.getElementById("msg");
        if(!el) return;
        if(!txt){ el.style.display="none"; el.textContent=""; return; }
        el.style.display="block";
        el.style.color = isErr ? "#ff6b6b" : "#9be09b";
        el.textContent = txt;
      }

      // ====== SW OFF (evita cache te mantendo em versão velha) ======
      async function disableServiceWorker(){
        try{
          if("serviceWorker" in navigator){
            const regs = await navigator.serviceWorker.getRegistrations();
            for(const r of regs){ try{ await r.unregister(); }catch(e){} }
          }
        }catch(e){}
        try{
          if("caches" in window){
            const keys = await caches.keys();
            for(const k of keys){ try{ await caches.delete(k); }catch(e){} }
          }
        }catch(e){}
      }
      disableServiceWorker();

      // ====== auth ======
      const AUTH_KEY = "TESOURA_AUTH";

      function cfg(){
        return window.TESOURA_CONFIG || {};
      }

      function validatePin(mode, pin){
        const C = cfg();
        const p = (pin || "").trim();
        if(!p) return false;

        // se você usa lista de senhas de diretoria (opcional)
        if(mode === "Diretoria" && Array.isArray(C.DIRECTOR_PINS) && C.DIRECTOR_PINS.length){
          return C.DIRECTOR_PINS.map(x=>String(x).trim()).includes(p);
        }

        // padrão: APP_PIN único (vale para ambos)
        const appPin = (C.APP_PIN || "").trim();
        if(appPin) return p === appPin;

        // se não tiver config, não deixa entrar (pra não ficar inseguro)
        return false;
      }

      function homeUrl(){
        // depois do login vai direto para JOGADORES (as abas aparecem via tesoura_nav.js no painel)
        return BASE_PATH + "legacy/tesoura_jogadores_teste.html" + buildQS();
      }

      function safeGoto(){
        const g = qp("goto");
        if(!g) return null;
        // só permite voltar para páginas do próprio /tesoura-app/
        try{
          const u = new URL(g, location.origin);
          if(!u.pathname.startsWith(BASE_PATH)) return null;
          return u.pathname + u.search;
        }catch(e){
          return null;
        }
      }

      function doLogoutIfAsked(){
        if(qp("logout")){
          try{ localStorage.removeItem(AUTH_KEY); }catch(e){}
          setMsg("Você saiu. Digite a senha para entrar novamente.", false);
        }
      }

      // UI
      const modeEl = document.getElementById("mode");
      const pinEl  = document.getElementById("pin");
      const btnEnter = document.getElementById("btnEnter");
      const btnClear = document.getElementById("btnClear");

      document.getElementById("buildBadge").textContent = "BUILD: " + (getBuild() || "—");
      document.getElementById("modeBadge").textContent  = "Modo: —";

      function enter(){
        const mode = modeEl.value;
        const pin = pinEl.value;

        if(!validatePin(mode, pin)){
          const hasCfg = !!(cfg().APP_PIN || (Array.isArray(cfg().DIRECTOR_PINS) && cfg().DIRECTOR_PINS.length));
          setMsg(hasCfg ? "Senha inválida." : "Config não encontrada (APP_PIN). Abra app/js/config.js.", true);
          return;
        }

        try{
          localStorage.setItem(AUTH_KEY, JSON.stringify({ ok:1, mode, ts: Date.now() }));
        }catch(e){}

        const g = safeGoto();
        location.href = g ? g : homeUrl();
      }

      btnEnter.addEventListener("click", enter);
      btnClear.addEventListener("click", ()=>{ pinEl.value=""; pinEl.focus(); setMsg("", false); });

      pinEl.addEventListener("keydown", (ev)=>{
        if(ev.key === "Enter"){ ev.preventDefault(); enter(); }
      });

      modeEl.addEventListener("change", ()=>{
        document.getElementById("modeBadge").textContent  = "Modo: " + modeEl.value;
      });
      document.getElementById("modeBadge").textContent  = "Modo: " + modeEl.value;

      doLogoutIfAsked();
      setMsg("", false);
    })();
  </script>
</body>
</html>
