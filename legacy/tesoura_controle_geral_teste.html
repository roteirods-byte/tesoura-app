<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - CONTROLE GERAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #fff; }
    header { padding: 14px 18px; border-bottom: 2px solid #f97316; display: flex; align-items: center; justify-content: space-between; background: #07101f; }
    header h1 { margin: 0; font-size: 16px; letter-spacing: 0.5px; color: #f97316; text-transform: uppercase; font-weight: 900; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .painel { background: #020617; border: 1px solid #0f172a; border-radius: 12px; padding: 12px; margin-bottom: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.35); }
    .painel h2 { margin: 0 0 10px; color: #f97316; font-size: 14px; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 900; }
    .status { margin-top: 8px; font-size: 12px; color: #9ca3af; }

    table { border-collapse: collapse; font-size: 12px; width: max-content; min-width: 100%; }
    thead th {
      position: sticky; top: 0;
      background: #f97316; color: #ffffff;
      z-index: 2;
      border: 1px solid rgba(255,255,255,0.45);
      padding: 6px 8px;
      text-align: center;
      white-space: nowrap;
      font-weight: 900;
      text-transform: uppercase;
    }
    tbody td {
      border: 1px solid rgba(255,255,255,0.20);
      padding: 5px 6px;
      text-align: center;
      white-space: nowrap;
      background: #020617;
      text-transform: uppercase;
    }
    tbody tr:nth-child(even) td { background: #061024; }

    .col-atleta { min-width: 140px; text-align: left; padding-left: 10px; font-weight: 900; }
    .col-faltas { min-width: 85px; font-weight: 900; }

    .sticky-atleta { position: sticky; left: 0; z-index: 3; background: #020617; }
    .sticky-faltas { position: sticky; left: 140px; z-index: 3; background: #020617; }
    thead .sticky-atleta, thead .sticky-faltas { z-index: 5; background: #f97316; color: #ffffff; }

    .sticky-faltas{
      border-left: 2px solid rgba(255,255,255,0.85) !important;
      border-right: 2px solid rgba(255,255,255,0.85) !important;
    }

    .pverde { color: #22c55e; font-weight: 900; }
    .pvermelho { color: #ef4444; font-weight: 900; }
  </style>
</head>
<body>

<header>
  <h1>TESOURA - CONTROLE GERAL</h1>
  <div style="font-size:12px;color:#9ca3af;">(somente visualização)</div>
</header>

<div class="wrap">
  <div class="painel">
    <h2>INFORMAÇÕES</h2>
    <p style="margin:0;font-size:12px;color:#cbd5e1;">
      OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) |
      <span class="pverde">P (verde)</span> pagou |
      <span class="pvermelho">P (vermelho)</span> não pagou.
    </p>
    <div class="status" id="status">Atualizando automaticamente...</div>
  </div>

  <div class="painel" style="overflow-x:auto; max-width:100%;">
    <h2>JOGADORES X DOMINGOS</h2>
    <table>
      <thead id="theadControle"></thead>
      <tbody id="tbodyControle"></tbody>
    </table>
  </div>
</div>

<script src="../app/js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const CFG = window.TESOURA_CONFIG || {};
  const SB_URL = CFG.SUPABASE_URL || "https://xuplzpispukvtggjasxx.supabase.co";
  const SB_KEY = CFG.SUPABASE_KEY || CFG.SUPABASE_ANON_KEY || "sb_publishable_uGvmPC40FfyxzS6Kh1gNHg_AO9wJ6kg";

  window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SB_URL, SB_KEY);
  const sb = window.__TESOURA_SUPABASE__;

  const statusEl = document.getElementById("status");
  const theadControle = document.getElementById("theadControle");
  const tbodyControle = document.getElementById("tbodyControle");

  const nomesMes = {
    1: "JANEIRO", 2: "FEVEREIRO", 3: "MARÇO", 4: "ABRIL",
    5: "MAIO", 6: "JUNHO", 7: "JULHO", 8: "AGOSTO",
    9: "SETEMBRO", 10: "OUTUBRO", 11: "NOVEMBRO", 12: "DEZEMBRO"
  };

  function lastDayOfMonth(ano, mes){ return new Date(ano, mes, 0).getDate(); }

  function getDomingosMes(ano, mes) {
    const domingos = [];
    const dt = new Date(ano, mes - 1, 1);
    while (dt.getMonth() === mes - 1) {
      if (dt.getDay() === 0) {
        const anoStr = dt.getFullYear();
        const mesStr = String(dt.getMonth() + 1).padStart(2, "0");
        const diaStr = String(dt.getDate()).padStart(2, "0");
        domingos.push({ iso: `${anoStr}-${mesStr}-${diaStr}`, rotulo: `${diaStr}/${mesStr}` });
      }
      dt.setDate(dt.getDate() + 1);
    }
    return domingos;
  }

  // MÊS VIGENTE + 2 ANTERIORES (DATA REAL DO COMPUTADOR, CRUZA ANO)
  function buildUltimos3Meses(){
    const hoje = new Date();
    const arr = [];
    for(let off=2; off>=0; off--){
      const d = new Date(hoje.getFullYear(), hoje.getMonth() - off, 1);
      arr.push({ ano: d.getFullYear(), mes: d.getMonth() + 1 });
    }
    return arr;
  }

  async function arquivarControleGeralVigente(conteudo){
    try{
      const painel = "controle geral";
      const periodo = "unico";
      const referencia = "vigente";
      const titulo = "Controle Geral (vigente)";

      const { data: existing, error: e1 } = await sb
        .from("arquivos_app")
        .select("id")
        .eq("painel", painel)
        .eq("periodo", periodo)
        .eq("referencia", referencia)
        .order("criado_em", { ascending: false })
        .limit(1);

      if(e1) throw e1;

      if(existing && existing.length){
        const { error: e2 } = await sb
          .from("arquivos_app")
          .update({ titulo, conteudo })
          .eq("id", existing[0].id);
        if(e2) throw e2;
      }else{
        const { error: e2 } = await sb
          .from("arquivos_app")
          .insert([{ painel, periodo, referencia, titulo, conteudo }]);
        if(e2) throw e2;
      }
    }catch(e){
      console.error("Auto-arquivo Controle Geral falhou:", e);
    }
  }

  async function carregarTabela() {
    try {
      statusEl.textContent = "CARREGANDO...";
      theadControle.innerHTML = "";
      tbodyControle.innerHTML = "";

      const mesesOrdem = buildUltimos3Meses();
      const domingosMes = mesesOrdem.map(mm => getDomingosMes(mm.ano, mm.mes));

      // ===== CABEÇALHO (2 LINHAS) NA TELA =====
      const trMeses = document.createElement("tr");
      const trDias  = document.createElement("tr");

      const thAtleta = document.createElement("th");
      thAtleta.textContent = "ATLETA";
      thAtleta.rowSpan = 2;
      thAtleta.className = "col-atleta sticky-atleta";
      trMeses.appendChild(thAtleta);

      const thTotalTop = document.createElement("th");
      thTotalTop.textContent = "TOTAL";
      thTotalTop.className = "col-faltas sticky-faltas";
      trMeses.appendChild(thTotalTop);

      const thFaltas = document.createElement("th");
      thFaltas.textContent = "FALTAS";
      thFaltas.className = "col-faltas sticky-faltas";
      trDias.appendChild(thFaltas);

      mesesOrdem.forEach((mm, idx) => {
        const listaDom = domingosMes[idx] || [];
        const thMes = document.createElement("th");
        thMes.colSpan = Math.max(1, listaDom.length);
        const nomeMes = nomesMes[mm.mes] || `MÊS ${mm.mes}`;
        thMes.textContent = `MÊS ${String(mm.mes).padStart(2,"0")} - ${nomeMes} - ${mm.ano}`;
        trMeses.appendChild(thMes);

        listaDom.forEach(d => {
          const thDia = document.createElement("th");
          thDia.textContent = d.rotulo;
          trDias.appendChild(thDia);
        });
      });

      theadControle.appendChild(trMeses);
      theadControle.appendChild(trDias);

      // ===== PERÍODO (3 MESES) =====
      const ini = mesesOrdem[0];
      const fim = mesesOrdem[2];
      const iniIso = `${ini.ano}-${String(ini.mes).padStart(2, "0")}-01`;
      const fimIso = `${fim.ano}-${String(fim.mes).padStart(2, "0")}-${String(lastDayOfMonth(fim.ano, fim.mes)).padStart(2,"0")}`;

      const { data: jogadores, error: errJog } = await sb
        .from("jogadores")
        .select("apelido")
        .order("apelido", { ascending: true });
      if (errJog) throw errJog;

      const { data: pres, error: errPres } = await sb
        .from("presencas")
        .select("data_jogo, apelido, presenca, faltoso")
        .gte("data_jogo", iniIso)
        .lte("data_jogo", fimIso);
      if (errPres) throw errPres;

      const { data: esc, error: errEsc } = await sb
        .from("escalacao")
        .select("data_jogo, apelido, tempo")
        .gte("data_jogo", iniIso)
        .lte("data_jogo", fimIso);
      if (errEsc) throw errEsc;

      const mapaPres = {};
      (pres || []).forEach(p => { mapaPres[`${p.apelido}::${p.data_jogo}`] = p; });

      const mapaEsc = {};
      (esc || []).forEach(e => {
        const key = `${e.apelido}::${e.data_jogo}`;
        if (!mapaEsc[key]) mapaEsc[key] = new Set();
        if (e.tempo !== null && e.tempo !== undefined && e.tempo !== "") mapaEsc[key].add(e.tempo);
      });

      // ===== SNAPSHOT PARA BANCO: COM MESCLAS (PDF/EXCEL) =====
      // headerRows (AOA) para CSV/Excel + merges + pdfHead (colSpan/rowSpan)
      const headRow1 = ["ATLETA", "TOTAL"];
      const headRow2 = ["", "FALTAS"];

      // merges (A1:A2) para ATLETA
      const merges = [{ s:{r:0,c:0}, e:{r:1,c:0} }];

      // pdfHead com mesclas (para ficar IGUAL ao painel)
      const pdfRow1 = [
        { content: "ATLETA", rowSpan: 2 },
        { content: "TOTAL" }
      ];
      const pdfRow2 = [
        { content: "FALTAS" }
      ];

      let colCursor = 2; // coluna C (0=A,1=B,2=C)
      mesesOrdem.forEach((mm, idx) => {
        const listaDom = domingosMes[idx] || [];
        const nomeMes = nomesMes[mm.mes] || `MÊS ${mm.mes}`;
        const labelMes = `MÊS ${String(mm.mes).padStart(2,"0")} - ${nomeMes} - ${mm.ano}`;

        const span = Math.max(1, listaDom.length);

        // AOA: coloca o label no primeiro, e blanks nos outros pra mesclar
        headRow1.push(labelMes);
        for(let k=1;k<span;k++) headRow1.push("");

        // merges do mês (linha 1)
        merges.push({ s:{r:0,c:colCursor}, e:{r:0,c:colCursor+span-1} });

        // PDF: célula com colSpan
        pdfRow1.push({ content: labelMes, colSpan: span });
        // precisa preencher placeholders pra colSpan (autoTable exige)
        for(let k=1;k<span;k++) pdfRow1.push({ content: "" });

        // linha 2: domingos
        listaDom.forEach(d => headRow2.push(d.rotulo));
        listaDom.forEach(d => pdfRow2.push({ content: d.rotulo }));

        colCursor += span;
      });

      // linhas
      const rowsSnap = [];
      (jogadores || []).forEach(j => {
        const apelido = j.apelido;
        const tr = document.createElement("tr");

        const tdAtleta = document.createElement("td");
        tdAtleta.textContent = (apelido || "").toUpperCase();
        tdAtleta.className = "col-atleta sticky-atleta";
        tr.appendChild(tdAtleta);

        const tdFaltas = document.createElement("td");
        tdFaltas.textContent = "0";
        tdFaltas.className = "col-faltas sticky-faltas";
        tr.appendChild(tdFaltas);

        let totalFaltas = 0;
        const row = [(apelido || "").toUpperCase(), "0"];

        mesesOrdem.forEach((mm, idx) => {
          const listaDom = domingosMes[idx] || [];
          listaDom.forEach(d => {
            const td = document.createElement("td");
            const key = `${apelido}::${d.iso}`;
            const presDia = mapaPres[key];
            let valor = "";

            if (presDia) {
              if (presDia.presenca) {
                const setTempos = mapaEsc[key] || new Set();
                const t1 = setTempos.has(1) || setTempos.has("1");
                const t2 = setTempos.has(2) || setTempos.has("2");
                if (t1 && t2) valor = "1-2";
                else if (t2) valor = "2";
                else if (t1) valor = "1";
                else valor = "C";
              } else if (presDia.faltoso) {
                valor = "F";
                totalFaltas += 1;
              }
            }

            td.textContent = valor;
            tr.appendChild(td);
            row.push(valor);
          });
        });

        tdFaltas.textContent = String(totalFaltas);
        row[1] = String(totalFaltas);

        tbodyControle.appendChild(tr);
        rowsSnap.push(row);
      });

      statusEl.textContent = "ATUALIZADO AUTOMATICAMENTE.";

      await arquivarControleGeralVigente({
        headerRows: [headRow1, headRow2],
        xlsxMerges: merges,
        pdfHead: [pdfRow1, pdfRow2],
        columns: headRow2,
        rows: rowsSnap
      });

    } catch (e) {
      console.error(e);
      statusEl.textContent = "ERRO (ver Console).";
      try{
        await arquivarControleGeralVigente({
          headerRows: [["ATLETA","TOTAL"],["","FALTAS"]],
          xlsxMerges: [{s:{r:0,c:0},e:{r:1,c:0}}],
          pdfHead: [[{content:"ATLETA",rowSpan:2},{content:"TOTAL"}],[{content:"FALTAS"}]],
          columns: ["ATLETA","TOTAL FALTAS"],
          rows: []
        });
      }catch(_){}
    }
  }

  carregarTabela();
</script>
</body>
</html>

