<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA - BANCO DE DADOS (GUARDIÃO)</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../app/js/config.js"></script>
  
  <style>
    :root{--bg:#081427;--card:#0b1b33;--card2:#0a1830;--line:#0f2a4a;--txt:#e9f2ff;--muted:#9fb3cc;--orange:#ff7f27;--red:#ff4d4d;--blueBtn:#58b4ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 12px 0;color:var(--orange);font-size:18px;letter-spacing:.5px}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    label{color:var(--muted);font-size:12px}
    select,input{height:36px;border-radius:8px;border:1px solid #163a63;background:#071225;color:var(--txt);padding:0 10px;min-width:220px}
    .btn{height:36px;border-radius:8px;border:0;padding:0 14px;font-weight:700;cursor:pointer}
    .btnGreen{background:#1fbf7a;color:#062015}
    .btnOrange{background:var(--orange);color:#2b1300}
    .btnBlue{background:var(--blueBtn);color:#06203a}
    .btnRed{background:var(--red);color:#2b0000}
    .small{font-size:12px;color:var(--muted)}
    .msg{margin-top:10px;font-size:12px;color:var(--orange)}
    .msgErr{color:var(--red)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:13px;text-align:left}
    th{color:var(--orange);font-weight:800}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .downloadBar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    .hint{margin-top:8px;font-size:12px;color:var(--muted)}
    .line{height:1px;background:var(--line);margin:10px 0}
    .muted{color:var(--muted)}
  </style>
  <script defer src="../app/js/tesoura_nav.js"></script>
</head>
<body>
  <div id="tesouraNav"></div>
  <div class="wrap">
    <h1>TESOURA - BANCO DE DADOS (GUARDIÃO)</h1>

    <div class="card">
      <div class="row">
        <div class="field">
          <label>PAINEL / ARQUIVO</label>
          <select id="fPainel">
            <option value="jogadores">jogadores</option>
            <option value="presenca">presenca</option>
            <option value="escalacao">escalacao</option>
            <option value="controle geral">controle geral</option>
            <option value="mensalidade">mensalidade</option>
            <option value="caixa">caixa</option>
            <option value="gols">gols</option>
          </select>
        </div>

        <div class="field">
          <label>PERÍODO</label>
          <select id="fPeriodo">
            <option value="unico">unico</option>
            <option value="semanal">semanal</option>
            <option value="mensal">mensal</option>
            <option value="anual">anual</option>
          </select>
        </div>

        <div class="field">
          <label>REFERÊNCIA</label>
          <input id="fRef" placeholder="Sem referência (arquivo único)" />
          <div class="small">Ex.: domingo, mês, ano (quando existir)</div>
        </div>

        <div class="actions" style="margin-left:auto">
          <button class="btn btnGreen" id="btnBuscar">BUSCAR</button>
          <button class="btn btnOrange" id="btnLimpar">LIMPAR</button>
        </div>
      </div>

      <div id="msg" class="msg" style="display:none"></div>

      <div class="line"></div>

      <div class="small">Banco de Dados é somente leitura. Aqui você baixa exatamente o que o painel salvou.</div>

      <table>
        <thead>
          <tr>
            <th>criado em</th>
            <th>título</th>
            <th>referência</th>
            <th>tipo</th>
            <th>excluir</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>

      <div class="downloadBar">
        <button class="btn btnBlue" id="btnPDF" disabled>BAIXAR PDF</button>
        <button class="btn btnBlue" id="btnCSV" disabled>BAIXAR CSV</button>
        <button class="btn btnBlue" id="btnXLS" disabled>BAIXAR EXCEL</button>
      </div>

      <div class="hint">Diretoria pode excluir arquivo salvo (quando permitido).</div>
    </div>
  </div>

<script>
let supabaseClient = null;

function showMsg(text, isErr=false){
  const el = document.getElementById("msg");
  el.style.display = "block";
  el.textContent = text;
  el.className = isErr ? "msg msgErr" : "msg";
}
function clearMsg(){
  const el = document.getElementById("msg");
  el.style.display = "none";
  el.textContent = "";
}
function initSupabase(url, key){
  try{
    supabaseClient = supabase.createClient(url, key);
    clearMsg();
  }catch(e){
    showMsg("Erro ao iniciar Supabase: " + e.message, true);
  }
}
function tryFallbackSupabase(){
  try{
    const cfg = window.TESOURA_CONFIG || {};
    const url = cfg.SUPABASE_URL;
    const key = cfg.SUPABASE_KEY || cfg.SUPABASE_ANON_KEY;
    if(url && key && !supabaseClient) initSupabase(url, key);
  }catch(_){}
}

function safeFilename(s){
  return (s || "arquivo").toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-zA-Z0-9_\-\.]+/g,"_")
    .replace(/_+/g,"_")
    .replace(/^_+|_+$/g,"");
}

function normalizeConteudo(conteudo){
  let c = conteudo;
  try{
    if(typeof c === "string"){
      const s = c.trim();
      if((s.startsWith("{") && s.endsWith("}")) || (s.startsWith("[") && s.endsWith("]"))){
        c = JSON.parse(s);
      }
    }
  }catch(_){}

  // ✅ Prioridade: HTML snapshot (fica idêntico ao painel)
  if(c && typeof c === "object" && (c.table_html || c.html_table)){
    return {
      title: c.title || "",
      table_html: c.table_html || c.html_table,
      table_css: c.table_css || ""
    };
  }

  // snapshot normal (rows/columns)
  if(c && typeof c === "object" && Array.isArray(c.rows)){
    return {
      title: c.title || "",
      headerRows: Array.isArray(c.headerRows) ? c.headerRows : null,
      columns: Array.isArray(c.columns) ? c.columns : (Array.isArray(c.headerRows) ? (c.headerRows[c.headerRows.length-1]||[]) : []),
      rows: c.rows
    };
  }

  // fallback genérico
  if(Array.isArray(c)){
    const first = c[0] || {};
    const columns = Object.keys(first);
    const rows = c.map(obj => columns.map(k => obj?.[k] ?? ""));
    return { columns, rows, headerRows:null };
  }
  if(typeof c === "object" && c){
    const columns = Object.keys(c);
    const rows = [columns.map(k => c[k] ?? "")];
    return { columns, rows, headerRows:null };
  }
  return { columns:["conteúdo"], rows:[[String(c ?? "")]], headerRows:null };
}

function buildTableHTMLFromSnapshot(norm){
  // se já veio pronto, usa
  if(norm.table_html) return norm.table_html;

  const headerRows = Array.isArray(norm.headerRows) ? norm.headerRows : null;
  const columns = Array.isArray(norm.columns) ? norm.columns : [];
  const rows = Array.isArray(norm.rows) ? norm.rows : [];

  let thead = "";
  if(headerRows && headerRows.length){
    thead = "<thead>" + headerRows.map(r=>{
      return "<tr>" + r.map(v=>`<th>${String(v ?? "").toUpperCase()}</th>`).join("") + "</tr>";
    }).join("") + "</thead>";
  }else{
    thead = "<thead><tr>" + columns.map(c=>`<th>${String(c ?? "").toUpperCase()}</th>`).join("") + "</tr></thead>";
  }

  const tbody = "<tbody>" + rows.map(r=>{
    return "<tr>" + (r||[]).map(v=>`<td>${String(v ?? "").toUpperCase()}</td>`).join("") + "</tr>";
  }).join("") + "</tbody>";

  return `<table>${thead}${tbody}</table>`;
}

function downloadBlob(filename, mime, content){
  const blob = new Blob([content], { type: mime });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 800);
}

function downloadCSV(filename, tableHtml){
  // extrai texto do table HTML -> CSV simples
  const div = document.createElement("div");
  div.innerHTML = tableHtml;
  const table = div.querySelector("table");
  const lines = [];
  (table.querySelectorAll("tr") || []).forEach(tr=>{
    const cells = Array.from(tr.querySelectorAll("th,td")).map(td=>{
      const v = (td.textContent || "").replace(/"/g,'""');
      return `"${v}"`;
    });
    lines.push(cells.join(","));
  });
  downloadBlob(filename, "text/csv;charset=utf-8", lines.join("\n"));
}

function downloadExcelXLS(filename, title, tableHtml, css){
  // ✅ Excel sem biblioteca: HTML workbook (.xls) — funciona em qualquer painel
  const xls =
`<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>
  body{font-family:Arial,Helvetica,sans-serif}
  h1{font-size:14px;margin:0 0 10px 0}
  table{border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #cfcfcf;padding:6px 8px;white-space:nowrap;text-align:center}
  th{background:#ff7f27;color:#fff;font-weight:700}
  ${css || ""}
</style>
</head>
<body>
<h1>${(title||"").toUpperCase()}</h1>
${tableHtml}
</body>
</html>`;
  downloadBlob(filename, "application/vnd.ms-excel;charset=utf-8", xls);
}

function openPrintWindow(title, tableHtml, css){
  // ✅ PDF idêntico: abre HTML e imprime (Salvar como PDF)
  const html =
`<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${title || "TESOURA"}</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px}
  h1{font-size:14px;margin:0 0 10px 0}
  table{border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #cfcfcf;padding:6px 8px;white-space:nowrap;text-align:center}
  th{background:#ff7f27;color:#fff;font-weight:800;text-transform:uppercase}
  td{text-transform:uppercase}
  ${css || ""}
</style>
</head>
<body>
<h1>${(title||"").toUpperCase()}</h1>
${tableHtml}
</body>
</html>`;

  const w = window.open("", "_blank");
  if(!w){
    showMsg("Pop-up bloqueado. Libere pop-up e tente novamente.", true);
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();

  // chama o print dentro do clique do usuário (evita bloqueio)
  setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){} }, 250);
}

let itens = [];
let selecionado = null;

function setDownloadEnabled(v){
  document.getElementById("btnPDF").disabled = !v;
  document.getElementById("btnCSV").disabled = !v;
  document.getElementById("btnXLS").disabled = !v;
}

function render(){
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  if(!itens.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">Nenhum arquivo salvo encontrado para este filtro.</td></tr>`;
    setDownloadEnabled(false);
    return;
  }

  itens.forEach((item, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.criado_em ?? "-"}</td>
      <td>${item.titulo ?? "-"}</td>
      <td>${item.referencia ?? "-"}</td>
      <td><span class="pill">${item.periodo ?? "-"}</span></td>
      <td><button class="btn btnRed" style="height:30px" data-del="${idx}">EXCLUIR</button></td>
    `;
    tr.style.cursor = "pointer";
    tr.addEventListener("click", (e) => {
      if(e.target && e.target.getAttribute && e.target.getAttribute("data-del") !== null) return;
      selecionado = item;
      setDownloadEnabled(true);
      clearMsg();
    });
    tb.appendChild(tr);
  });

  tb.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      const i = Number(btn.getAttribute("data-del"));
      const item = itens[i];
      if(!item) return;
      if(!confirm("Excluir este arquivo salvo?")) return;

      tryFallbackSupabase();
      if(!supabaseClient){
        showMsg("Supabase não inicializado (volte para o login).", true);
        return;
      }

      try{
        const { error } = await supabaseClient.from("arquivos_app").delete().eq("id", item.id);
        if(error) throw error;
        showMsg("Arquivo excluído.");
        await buscar();
      }catch(err){
        showMsg("Erro ao excluir: " + (err?.message || err), true);
      }
    });
  });

  setDownloadEnabled(false);
}

async function buscar(){
  clearMsg();
  tryFallbackSupabase();

  if(!supabaseClient){
    showMsg("Supabase não inicializado (volte para o login).", true);
    return;
  }

  const painel = document.getElementById("fPainel").value;
  const periodo = document.getElementById("fPeriodo").value;
  const ref = (document.getElementById("fRef").value || "").trim();

  let q = supabaseClient.from("arquivos_app").select("*")
    .eq("painel", painel)
    .eq("periodo", periodo)
    .order("criado_em", { ascending: false });

  if(ref) q = q.eq("referencia", ref);

  const { data, error } = await q;
  if(error){
    showMsg("Erro ao buscar: " + error.message, true);
    return;
  }

  itens = (data || []).map(x => ({
    id: x.id,
    painel: x.painel,
    periodo: x.periodo,
    referencia: x.referencia,
    titulo: x.titulo,
    criado_em: x.criado_em,
    conteudo: x.conteudo
  }));

  selecionado = null;
  render();
}

function limpar(){
  document.getElementById("fRef").value = "";
  itens = [];
  selecionado = null;
  clearMsg();
  render();
}

function baixar(tipo){
  if(!selecionado){
    showMsg("Selecione um arquivo salvo na lista.", true);
    return;
  }

  const item = selecionado;
  const norm = normalizeConteudo(item.conteudo);

  const stamp = new Date().toISOString().replace(/[:\-]/g,"").slice(0,15);
  const base = `${safeFilename(item.painel)}_${safeFilename(item.periodo)}_${stamp}`;
  const title = item.titulo || "Arquivo salvo";

  const tableHtml = buildTableHTMLFromSnapshot(norm);
  const css = norm.table_css || "";

  if(tipo === "pdf"){
    // ✅ PDF idêntico (Salvar como PDF)
    openPrintWindow(title, tableHtml, css);
    return;
  }
  if(tipo === "csv"){
    downloadCSV(`${base}.csv`, tableHtml);
    return;
  }
  // Excel
  downloadExcelXLS(`${base}.xls`, title, tableHtml, css);
}

window.addEventListener("message", (ev)=>{
  const msg = ev.data || {};
  if(msg.type === "TESOURA_SUPABASE_CONFIG"){
    initSupabase(msg.url, msg.key);
  }
});

document.getElementById("btnBuscar").addEventListener("click", buscar);
document.getElementById("btnLimpar").addEventListener("click", limpar);
document.getElementById("btnPDF").addEventListener("click", ()=>baixar("pdf"));
document.getElementById("btnCSV").addEventListener("click", ()=>baixar("csv"));
document.getElementById("btnXLS").addEventListener("click", ()=>baixar("xls"));

tryFallbackSupabase();
render();
</script>
</body>
</html>
