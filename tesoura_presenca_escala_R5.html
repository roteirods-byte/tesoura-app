<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>

  <!-- SUPABASE + CONFIG DO APP (obrigatórios dentro do iframe) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app/js/config.js"></script>

  <style>
    :root{
      --bg:#071a2b; --panel:#0b2640; --panel2:#082033;
      --txt:#e8f0ff; --muted:#a9bfdc; --accent:#ff8a00;
      --btn:#1da2ff; --btn2:#00c26a; --danger:#ff3b3b;
      --line:rgba(255,255,255,.12);
      --ok:#00c26a;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif;}
    .wrap{max-width:1180px;margin:16px auto;padding:0 12px;}
    h1{margin:0 0 10px;color:var(--accent);font-size:16px;letter-spacing:.4px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:12px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:9px 12px;border-radius:10px;border:0;color:#00121f;font-weight:800;cursor:pointer}
    .btn-primario{background:var(--btn2)}
    .btn-sec{background:#ffb000}
    .btn-blue{background:var(--btn)}
    .btn-danger{background:var(--danger);color:#fff}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:var(--accent);font-size:12px}
    tr:hover{background:rgba(255,255,255,.04)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .pill-ok{background:rgba(0,194,106,.15);color:var(--ok);border:1px solid rgba(0,194,106,.35)}
    .pill-bad{background:rgba(255,59,59,.12);color:#ffb0b0;border:1px solid rgba(255,59,59,.35)}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:12px;z-index:9999;
      background:#031220;border:1px solid var(--line);
      padding:10px 12px;border-radius:12px;display:none;
      max-width:92vw;white-space:pre-wrap
    }
    .toast.show{display:block}
    .toast .t{color:var(--accent);font-weight:900}
    .toast .m{color:var(--txt);margin-top:4px;font-size:12px}
    .cols{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width: 980px){ .cols{grid-template-columns:1fr;} }
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi b{color:var(--accent)}
    .btn-chegou{background:#173a5b;color:var(--txt);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-saiu{background:#1a2f45;color:#fff;border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:10px;font-weight:900;cursor:pointer}
  </style>
</head>

<body>
<div class="wrap">
  <h1>PRESENÇA / ESCALAÇÃO</h1>

  <div class="card">
    <div class="row">
      <div class="kpi small">
        <span><b id="infoDataJogo">DIA DO JOGO:</b> <span id="infoDataJogoVal">-</span></span>
        <span>|</span>
        <span><b>Presentes hoje:</b> <span id="infoPresentes">0</span></span>
        <span>|</span>
        <span><b>Status:</b> <span id="statusSupabase">-</span></span>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btn-limpar-presentes" class="btn btn-sec">Limpar hoje</button>
      <button id="btn-escalar-1t" class="btn btn-primario">Escalar 1º tempo</button>
      <button id="btn-escalar-2t" class="btn btn-primario">Escalar 2º tempo</button>
      <button id="btn-salvar-jogo" class="btn btn-blue">Salvar (Presença + Escalação)</button>
      <span class="small" id="msgSalvar"></span>
    </div>

    <div class="small" style="margin-top:10px">
      Regras: 1º tempo usa corte <b>06:15</b> para quem entra no “corte”. (Não bloqueia o botão.)
    </div>
  </div>

  <div class="cols" style="margin-top:12px">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b style="color:var(--accent)">JOGADORES</b>
        <span class="small" id="statusJogadores">-</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>apelido</th>
            <th>pontos</th>
            <th>inadimplente</th>
            <th>ação</th>
          </tr>
        </thead>
        <tbody id="tbody-jogadores-todos"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b style="color:var(--accent)">PRESENTES HOJE</b>
        <span class="small" id="statusPresentes">-</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>ordem</th>
            <th>apelido</th>
            <th>hora</th>
            <th>status</th>
            <th>obs</th>
          </tr>
        </thead>
        <tbody id="tbody-presentes-hoje"></tbody>
      </table>
    </div>
  </div>

  <div class="cols" style="margin-top:12px">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b style="color:var(--accent)">ESCALAÇÃO 1º TEMPO</b>
        <span class="small" id="totais-1t">-</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>time</th>
            <th>apelido</th>
            <th>ação</th>
          </tr>
        </thead>
        <tbody id="tbody-1t"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b style="color:var(--accent)">ESCALAÇÃO 2º TEMPO</b>
        <span class="small" id="totais-2t">-</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>time</th>
            <th>apelido</th>
            <th>ação</th>
          </tr>
        </thead>
        <tbody id="tbody-2t"></tbody>
      </table>
    </div>
  </div>

</div>

<div class="toast" id="toast">
  <div class="t" id="toastTitle">TESOURA</div>
  <div class="m" id="toastMsg"></div>
</div>

<script>
/* =========================
   SUPABASE (config do app)
========================= */
function getCfgSafe(){
  let cfg = window.TESOURA_CONFIG || {};
  if((!cfg.SUPABASE_URL || !cfg.SUPABASE_KEY) && window.parent && window.parent !== window){
    try{
      const pCfg = window.parent.TESOURA_CONFIG || {};
      cfg = {
        SUPABASE_URL: cfg.SUPABASE_URL || pCfg.SUPABASE_URL,
        SUPABASE_KEY: cfg.SUPABASE_KEY || pCfg.SUPABASE_KEY,
      };
    }catch(e){}
  }
  return cfg || {};
}
const __cfg = getCfgSafe();
const SUPABASE_URL = (__cfg.SUPABASE_URL || "").trim();
const SUPABASE_KEY = (__cfg.SUPABASE_KEY || "").trim();

const statusSupabaseEl = document.getElementById("statusSupabase");
if(!SUPABASE_URL || !SUPABASE_KEY){
  statusSupabaseEl.innerHTML = '<span class="pill pill-bad">CONFIG AUSENTE</span>';
  alert("ERRO: CONFIG SUPABASE ausente. Verifique app/js/config.js (TESOURA_CONFIG).");
}
window.__TESOURA_SUPABASE__ = window.__TESOURA_SUPABASE__ || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var supabase = window.__TESOURA_SUPABASE__;
statusSupabaseEl.innerHTML = '<span class="pill pill-ok">OK</span>';

/* =========================
   ESTADO + ELEMENTOS
========================= */
const infoDataJogoValEl = document.getElementById("infoDataJogoVal");
const infoPresentesEl = document.getElementById("infoPresentes");
const msgSalvarEl = document.getElementById("msgSalvar");
const statusJogadoresEl = document.getElementById("statusJogadores");
const statusPresentesEl = document.getElementById("statusPresentes");

const tbodyJogadoresTodos = document.getElementById("tbody-jogadores-todos");
const tbodyPresentesHoje = document.getElementById("tbody-presentes-hoje");

const btnLimparPresentes = document.getElementById("btn-limpar-presentes");
const btnEscalar1T = document.getElementById("btn-escalar-1t");
const btnEscalar2T = document.getElementById("btn-escalar-2t");
const btnSalvarJogo = document.getElementById("btn-salvar-jogo");

const tbody1T = document.getElementById("tbody-1t");
const tbody2T = document.getElementById("tbody-2t");
const totais1TEl = document.getElementById("totais-1t");
const totais2TEl = document.getElementById("totais-2t");

let dataJogoIso = null;
let todosJogadores = [];
let mapaJogadores = {};
let presentesHoje = [];
let presencasHoje = []; // alias usado na escalação
let escala1t = null;
let escala2t = null;

const HORARIO_CORTE_1T = "06:15";

/* =========================
   TOAST (mensagem visível)
========================= */
function toast(msg, ok=true){
  const t = document.getElementById("toast");
  document.getElementById("toastTitle").textContent = ok ? "OK" : "ERRO";
  document.getElementById("toastMsg").textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 5000);
}

/* =========================
   HELPERS
========================= */
function hojeIso(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function horaAgoraStr(){
  const d = new Date();
  return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false});
}
function horaMenorOuIgual(a,b){
  return (a||"").localeCompare(b||"") <= 0;
}
function atualizarInfoPresentes(){
  infoPresentesEl.textContent = String(presentesHoje.length);
}
function getDataJogoISO(){
  return dataJogoIso || hojeIso();
}
function mesAnoRef(){
  const d = new Date(getDataJogoISO()+"T00:00:00");
  return { mes_ref: String(d.getMonth()+1), ano_ref: String(d.getFullYear()) };
}

/* =========================
   RENDER
========================= */
function renderJogadores(){
  tbodyJogadoresTodos.innerHTML = "";
  todosJogadores.forEach(j=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.apelido||"-"}</td>
      <td>${Number(j.pontos||0)}</td>
      <td>${j.inadimplente ? '<span class="pill pill-bad">P</span>' : '<span class="pill pill-ok">OK</span>'}</td>
      <td></td>
    `;
    const tdBtn = tr.querySelector("td:last-child");
    const bt = document.createElement("button");
    bt.textContent = "CHEGOU AGORA";
    bt.className = "btn-chegou";
    bt.onclick = ()=>marcarChegada(j);
    tdBtn.appendChild(bt);
    tbodyJogadoresTodos.appendChild(tr);
  });
}

function renderPresentes(){
  tbodyPresentesHoje.innerHTML = "";
  const ordenados = [...presentesHoje].sort((a,b)=>(a.ordem||0)-(b.ordem||0));
  ordenados.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.ordem||"-"}</td>
      <td>${p.apelido||"-"}</td>
      <td>${p.hora||"-"}</td>
      <td>${p.status||"P"}</td>
      <td>${p.obs||""}</td>
    `;
    tbodyPresentesHoje.appendChild(tr);
  });
  atualizarInfoPresentes();
}

function renderEscalacoes(){
  tbody1T.innerHTML = "";
  tbody2T.innerHTML = "";

  const a1 = escala1t?.amarelo || [];
  const z1 = escala1t?.azul || [];
  const a2 = escala2t?.amarelo || [];
  const z2 = escala2t?.azul || [];

  totais1TEl.textContent = `amarelo: ${a1.length} | azul: ${z1.length}`;
  totais2TEl.textContent = `amarelo: ${a2.length} | azul: ${z2.length}`;

  function linha(tbody, time, apelido, is1t){
    const tr = document.createElement("tr");
    const saiu = presentesHoje.find(x=>x.apelido===apelido)?.saiu ? " (SAIU)" : "";
    tr.innerHTML = `
      <td>${time}</td>
      <td>${apelido}${saiu}</td>
      <td></td>
    `;
    const td = tr.querySelector("td:last-child");
    const bt = document.createElement("button");
    bt.textContent = "SAÍU";
    bt.className = "btn-saiu";
    bt.onclick = ()=>toggleSaiu(apelido);
    td.appendChild(bt);
    tbody.appendChild(tr);
  }

  a1.forEach(ap=>linha(tbody1T, "amarelo", ap, true));
  z1.forEach(ap=>linha(tbody1T, "azul", ap, true));
  a2.forEach(ap=>linha(tbody2T, "amarelo", ap, false));
  z2.forEach(ap=>linha(tbody2T, "azul", ap, false));
}

/* =========================
   CARGA BASE
========================= */
async function carregarBase(){
  try{
    dataJogoIso = hojeIso();
    infoDataJogoValEl.textContent = dataJogoIso.split("-").reverse().join("/");
    msgSalvarEl.textContent = "";

    statusJogadoresEl.textContent = "Carregando jogadores...";
    statusPresentesEl.textContent = "Carregando presença...";
    tbodyJogadoresTodos.innerHTML = "";
    tbodyPresentesHoje.innerHTML = "";
    presentesHoje = [];
    presencasHoje = [];
    escala1t = null;
    escala2t = null;

    // jogadores
    const { data: jogs, error: errJ } = await supabase.from("jogadores").select("*").order("apelido",{ascending:true});
    if(errJ) throw errJ;

    // presença hoje
    const dia = getDataJogoISO();
    const { data: pres, error: errP } = await supabase
      .from("presencas")
      .select("*")
      .eq("data_jogo", dia)
      .order("ordem",{ascending:true});
    if(errP) throw errP;

    todosJogadores = (jogs||[]).map(j=>({
      id:j.id, apelido:j.apelido, pontos:Number(j.pontos||0),
      inadimplente: !!j.inadimplente
    }));
    mapaJogadores = {};
    todosJogadores.forEach(j=>mapaJogadores[j.apelido]=j);

    presentesHoje = (pres||[]).map(p=>({
      id:p.id, apelido:p.apelido, ordem:p.ordem||0,
      hora:(p.hora_chegada||p.hora||""),
      naoVaiJogar: !!p.nao_vai_jogar,
      status: p.status||"P",
      obs: p.obs||"",
      saiu: !!p.saiu
    }));
    presencasHoje = presentesHoje;

    statusJogadoresEl.textContent = `OK (${todosJogadores.length})`;
    statusPresentesEl.textContent = `OK (${presentesHoje.length})`;
    renderJogadores();
    renderPresentes();
    renderEscalacoes();
  }catch(e){
    console.error(e);
    statusJogadoresEl.textContent = "ERRO";
    statusPresentesEl.textContent = "ERRO";
    toast("Falha ao carregar base (veja Console).", false);
    alert("ERRO ao carregar base. Abra F12 > Console para ver o motivo.");
  }
}

/* =========================
   PRESENÇA
========================= */
async function marcarChegada(j){
  try{
    const apelido = j?.apelido;
    if(!apelido) return;

    const dia = getDataJogoISO();
    const hora = horaAgoraStr();

    // ordem = próximo
    const maxOrdem = presentesHoje.reduce((m,x)=>Math.max(m, Number(x.ordem||0)), 0);
    const ordem = maxOrdem + 1;

    const payload = {
      data_jogo: dia,
      apelido,
      hora_chegada: hora,
      ordem,
      nao_vai_jogar: false,
      status: "P",
      obs: ""
    };

    const { data, error } = await supabase.from("presencas").insert([payload]).select("*").single();
    if(error) throw error;

    presentesHoje.push({
      id:data.id, apelido:data.apelido, ordem:data.ordem,
      hora:data.hora_chegada, naoVaiJogar:false, status:"P", obs:"", saiu:false
    });
    presencasHoje = presentesHoje;
    renderPresentes();
    toast("Chegada registrada.");
  }catch(e){
    console.error(e);
    toast("Erro ao registrar chegada.", false);
  }
}

async function limparPresentesHoje(){
  try{
    const dia = getDataJogoISO();
    const { error } = await supabase.from("presencas").delete().eq("data_jogo", dia);
    if(error) throw error;

    presentesHoje = [];
    presencasHoje = [];
    escala1t = null;
    escala2t = null;
    renderPresentes();
    renderEscalacoes();
    toast("Presença de hoje limpa.");
  }catch(e){
    console.error(e);
    toast("Erro ao limpar presença.", false);
  }
}

/* =========================
   ESCALAÇÃO (1T / 2T)
========================= */
function distribuiEquilibrado(entradas){
  // entradas: [{apelido, pontos}]
  const sorted = [...entradas].sort((a,b)=>Number(b.pontos||0)-Number(a.pontos||0));
  const amarelo=[], azul=[];
  let sa=0, sz=0;
  sorted.forEach(x=>{
    if(sa<=sz){ amarelo.push(x); sa+=Number(x.pontos||0); }
    else { azul.push(x); sz+=Number(x.pontos||0); }
  });
  return { amarelo, azul };
}

async function escalarPrimeiroTempo(){
  try{
    const listaHoje = (presencasHoje || []).filter(p => !p.naoVaiJogar);

    const listaCorte = listaHoje
      .filter(p => horaMenorOuIgual(p.hora, HORARIO_CORTE_1T))
      .sort((a,b)=> (a.ordem||0) - (b.ordem||0));

    let selecionados = [];

    if(listaCorte.length >= 25){
      // aqui você pode colocar regras de eliminação depois (se quiser)
      selecionados = listaCorte.slice(0,20);
    }else{
      selecionados = listaHoje.sort((a,b)=> (a.ordem||0)-(b.ordem||0)).slice(0,20);
    }

    const entradas = selecionados.map(p=>{
      const j = mapaJogadores[p.apelido] || {};
      return { apelido: p.apelido, pontos: Number(j.pontos||0) };
    });

    const { amarelo, azul } = distribuiEquilibrado(entradas);

    escala1t = { amarelo: amarelo.map(x=>x.apelido), azul: azul.map(x=>x.apelido) };

    const entrouSet = new Set([...escala1t.amarelo, ...escala1t.azul]);
    presentesHoje.forEach(p=>{
      if(p.naoVaiJogar) return;
      if(entrouSet.has(p.apelido)) p.status = "1";
      else if(!p.status || p.status==="P") p.status = "C";
    });

    renderPresentes();
    renderEscalacoes();
    toast("Escalação 1º tempo gerada.");
  }catch(e){
    console.error(e);
    toast("ERRO na ESCALAÇÃO 1º TEMPO: " + (e.message||e), false);
    alert("ERRO na ESCALAÇÃO 1º TEMPO. Veja Console (F12).");
  }
}

async function escalarSegundoTempo(){
  try{
    const presentes = (presencasHoje || []).filter(p => !p.naoVaiJogar);
    const jogou1tSet = new Set([...(escala1t?.amarelo||[]), ...(escala1t?.azul||[])]);
    const naoJogou1t = presentes.filter(p => !jogou1tSet.has(p.apelido));
    const jogou1t = presentes.filter(p => jogou1tSet.has(p.apelido));

    const totalDesejado = Math.min(20, presentes.length);

    let selecionados = [];
    if(naoJogou1t.length >= totalDesejado){
      selecionados = naoJogou1t.sort((a,b)=>(a.ordem||0)-(b.ordem||0)).slice(0,totalDesejado);
    }else{
      const falta = totalDesejado - naoJogou1t.length;
      selecionados = [...naoJogou1t, ...jogou1t.sort((a,b)=>(a.ordem||0)-(b.ordem||0)).slice(0,falta)];
    }

    const entradas = selecionados.map(p=>{
      const j = mapaJogadores[p.apelido] || {};
      return { apelido: p.apelido, pontos: Number(j.pontos||0) };
    });

    const { amarelo, azul } = distribuiEquilibrado(entradas);

    escala2t = { amarelo: amarelo.map(x=>x.apelido), azul: azul.map(x=>x.apelido) };

    const entrou2Set = new Set([...escala2t.amarelo, ...escala2t.azul]);
    presentesHoje.forEach(p=>{
      if(p.naoVaiJogar) return;
      if(entrou2Set.has(p.apelido)) p.status = "2";
    });

    renderPresentes();
    renderEscalacoes();
    toast("Escalação 2º tempo gerada.");
  }catch(e){
    console.error(e);
    toast("ERRO na ESCALAÇÃO 2º TEMPO: " + (e.message||e), false);
    alert("ERRO na ESCALAÇÃO 2º TEMPO. Veja Console (F12).");
  }
}

function toggleSaiu(apelido){
  const p = presentesHoje.find(x=>x.apelido===apelido);
  if(!p) return;
  p.saiu = !p.saiu;
  renderEscalacoes();
}

/* =========================
   SALVAR (arquivo histórico)
   - evita acúmulo: 1 arquivo por data_ref
========================= */
async function salvarJogo(){
  try{
    const dia = getDataJogoISO();
    const { mes_ref, ano_ref } = mesAnoRef();

    // Conteúdos
    const conteudoPresenca = {
      data_jogo: dia,
      presentes: presentesHoje,
      gerado_em: new Date().toISOString()
    };

    const conteudoEscalacao = {
      data_jogo: dia,
      escala_1t: escala1t,
      escala_2t: escala2t,
      gerado_em: new Date().toISOString()
    };

    msgSalvarEl.textContent = "Salvando…";

    // PRESENÇA: mantém 1 arquivo por domingo (delete + insert)
    await supabase.from("arquivos_app").delete()
      .eq("painel","presenca").eq("periodo","semanal").eq("data_ref",dia);

    await supabase.from("arquivos_app").insert([{
      painel: "presenca",
      periodo: "semanal",
      data_ref: dia,
      mes_ref,
      ano_ref,
      titulo: `Presença ${dia}`,
      conteudo: conteudoPresenca
    }]);

    // ESCALAÇÃO: mantém 1 arquivo por domingo (delete + insert)
    await supabase.from("arquivos_app").delete()
      .eq("painel","escalacao").eq("periodo","semanal").eq("data_ref",dia);

    await supabase.from("arquivos_app").insert([{
      painel: "escalacao",
      periodo: "semanal",
      data_ref: dia,
      mes_ref,
      ano_ref,
      titulo: `Escalação ${dia}`,
      conteudo: conteudoEscalacao
    }]);

    msgSalvarEl.textContent = "Salvo.";
    toast("Presença + Escalação arquivadas (1 arquivo por data).");
  }catch(e){
    console.error(e);
    msgSalvarEl.textContent = "";
    toast("Erro ao salvar. Veja Console (F12).", false);
    alert("ERRO ao salvar. Veja Console (F12).");
  }
}

/* =========================
   EVENTOS + INIT
========================= */
btnLimparPresentes.addEventListener("click", limparPresentesHoje);
btnEscalar1T.addEventListener("click", escalarPrimeiroTempo);
btnEscalar2T.addEventListener("click", escalarSegundoTempo);
btnSalvarJogo.addEventListener("click", salvarJogo);

carregarBase();
</script>
</body>
</html>
